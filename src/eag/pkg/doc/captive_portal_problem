今天收到大唐一个反馈，有个局点的省公司portal server挂掉了，用户不能认证。
需要把CMCC-EDU的portal功能关闭，而CMCC的portal功能要继续开启。


出现的问题是，当前这两个ssid下的用户，都是从同一个ebr下接入的，
按照我们captive portal的设计，是没办法将来自不同ssid的用户区分开的，
这就导致前方的需求没办法实现。


从实际前方的使用情况来看，不同ssid挂在同一个三层接口下，
并且一个ssid不开portal，一个开portal，这样的需求还是有较大可能的。
从用户的角度来讲，可能更认同基于ssid或者说基于热点的portal功能。


之前曾经有局点也提到过这样的需求，最终的结果是让前方修改了网络的布局，
直接将不同的ssid挂在了不同的三层接口下面了。


从我个人的角度来讲，一直希望能够将captive portal的功能下层到内核
(其实现在也是在内核，只不过是内核自己的代码我们没办法控制)，并且能够监控
用户的无线信息，以及所有的流量，这样才有可能实现更灵活的控制。
而当前能实现这个功能最接近的就是wsm模块了。
wsm模块实现的是capwap报文解封包，然后再转发用户报文。


另外还有一种方案就是实现一个内核模块，这个内核模块工作在netfilter之上，
能够记录所有的转发信息甚至流量信息，当然还需要包括用户的无线信息。
这个内核模块可以参考ip set的实现来处理，实际实现后应该比ipset要复杂的多。
这个实现的难度也是比较大的，主要表现在可靠性和性能上面，因为工作在内核，
不允许有任何的异常。涉及到转发，性能必须要保证。而且这个设计目前会受到
快速转发的影响。


关于最早coova chilli的实现，其是通过RAW_SOCKET来监控了所有的用户流量的，
在coova chilli的实现中，还包括了dhcp，路由转发，流量控制等。
coova chilli的实现是基于胖ap的，内部功能多，而实际的工作压力(cpu消耗)
还是比较小的。其实如果最早将captive portal的功能实现到瘦ap上，
可能现在的处理会简单一些。


另外一个有缺陷的方案就是，在用户做url重定向的时候，如果发现其来之某个ssid，
就直接授权，url重定向返回的url不是portal的url，而是之前他请求的url。
这样做的缺陷就是用户的第一个请求必须是http的。
这个和我们客户的期望肯定还是不一样的。
与其解释半天，还不如就不做，按照不同ssid，放在不同的三层接口这样的配置方向向客户推荐。




