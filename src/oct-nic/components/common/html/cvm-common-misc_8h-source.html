<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Octeon Common Component: cvm-common-misc.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>cvm-common-misc.h</h1><a href="cvm-common-misc_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/***********************************************************************</span>
00002 <span class="comment"></span>
00003 <span class="comment">  OCTEON TOOLKITS                                                         </span>
00004 <span class="comment">  Copyright (c) 2007 Cavium Networks. All rights reserved.</span>
00005 <span class="comment"></span>
00006 <span class="comment">  This file, which is part of the OCTEON TOOLKIT from Cavium Networks,</span>
00007 <span class="comment">  contains proprietary and confidential information of Cavium Networks</span>
00008 <span class="comment">  and in some cases its suppliers.</span>
00009 <span class="comment"></span>
00010 <span class="comment">  Any licensed reproduction, distribution, modification, or other use of</span>
00011 <span class="comment">  this file or confidential information embodied in this file is subject</span>
00012 <span class="comment">  to your license agreement with Cavium Networks. The applicable license</span>
00013 <span class="comment">  terms can be found by contacting Cavium Networks or the appropriate</span>
00014 <span class="comment">  representative within your company.</span>
00015 <span class="comment"></span>
00016 <span class="comment">  All other use and disclosure is prohibited.</span>
00017 <span class="comment"></span>
00018 <span class="comment">  Contact Cavium Networks at info@caviumnetworks.com for more information.</span>
00019 <span class="comment"></span>
00020 <span class="comment"> ************************************************************************/</span> 
00021 
00022 <span class="preprocessor">#ifndef __CVM_COMMON_MISC_H__</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#define __CVM_COMMON_MISC_H__</span>
00024 <span class="preprocessor"></span>
00025 
00026 <span class="preprocessor">#if !(defined(__KERNEL__) &amp;&amp; defined(linux))</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#if !(defined(__KERNEL__) &amp;&amp; defined(linux))</span>
00031 <span class="preprocessor"></span>
00032 <span class="preprocessor">#include "cvmx-scratch.h"</span>
00033 
<a name="l00034"></a><a class="code" href="cvm-common-misc_8h.html#a28">00034</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-misc_8h.html#a28">cvm_common_set_cycle</a>(uint64_t cycle)
00035 {
00036     uint32_t val_low  = cycle &amp; 0xffffffff;
00037     uint32_t val_high = cycle  &gt;&gt; 32;
00038     
00039     uint32_t tmp; <span class="comment">/* temp register */</span>
00040 
00041     <span class="keyword">asm</span> <span class="keyword">volatile</span> (
00042         <span class="stringliteral">"  .set push\n"</span>
00043         <span class="stringliteral">"  .set mips64                       \n"</span>
00044         <span class="stringliteral">"  .set noreorder                    \n"</span>
00045         <span class="comment">/* Standard twin 32 bit -&gt; 64 bit construction */</span>
00046         <span class="stringliteral">"  dsll  %[valh], 32                 \n"</span>
00047         <span class="stringliteral">"  dla   %[tmp], 0xffffffff          \n"</span>
00048         <span class="stringliteral">"  and   %[vall], %[tmp], %[vall]    \n"</span>
00049         <span class="stringliteral">"  daddu %[valh], %[valh], %[vall]   \n"</span>
00050         <span class="comment">/* Combined value is in valh */</span>
00051         <span class="stringliteral">"  dmtc0 %[valh],$9, 6               \n"</span>
00052         <span class="stringliteral">"  .set pop\n"</span>                                             \
00053          :[tmp] <span class="stringliteral">"=&amp;r"</span> (tmp) : [valh] <span class="stringliteral">"r"</span> (val_high), [vall] <span class="stringliteral">"r"</span> (val_low) );
00054 
00055 }
00056 
00057 
00058 <span class="preprocessor">#endif </span><span class="comment">/* KERNEL */</span>
00059 
<a name="l00060"></a><a class="code" href="cvm-common-misc_8h.html#a29">00060</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-misc_8h.html#a29">cvm_common_enqueue_frame</a> (<a class="code" href="structcvm__common__wqe.html">cvm_common_wqe_t</a> *swp)
00061 {
00062    <span class="keywordflow">if</span> (<a class="code" href="cvm-common-defs_8h.html#a85">out_swp</a> == NULL)
00063    {
00064       swp-&gt;<a class="code" href="structcvm__common__wqe.html#o1">next</a> = <a class="code" href="cvm-common-defs_8h.html#a85">out_swp</a>;
00065       <a class="code" href="cvm-common-defs_8h.html#a85">out_swp</a> = <a class="code" href="cvm-common-defs_8h.html#a86">out_swp_tail</a> = swp;
00066    }
00067    <span class="keywordflow">else</span>
00068    {
00069       swp-&gt;<a class="code" href="structcvm__common__wqe.html#o1">next</a> = NULL;
00070       <a class="code" href="cvm-common-defs_8h.html#a86">out_swp_tail</a>-&gt;<a class="code" href="structcvm__common__wqe.html#o1">next</a> = swp;
00071       <a class="code" href="cvm-common-defs_8h.html#a86">out_swp_tail</a> = swp;
00072    }
00073 }
00074 
00075 
00076 <span class="preprocessor">#if !(defined(__KERNEL__) &amp;&amp; defined(linux))</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#ifdef REAL_HW</span>
00078 <span class="preprocessor"></span>
00079 <span class="comment">/* support routines and macros to output the results to LED display */</span>
00080 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> cvm_common_int2ascii_hex(<span class="keywordtype">int</span> number, <span class="keywordtype">int</span> digit_count, <span class="keywordtype">char</span>* str)
00081 {
00082   <span class="keywordtype">int</span> max_digits = 8;
00083   <span class="keywordtype">int</span> i = 0, j = 0;
00084 
00085   <span class="keywordflow">if</span> (digit_count &gt; max_digits) <span class="keywordflow">return</span> (-1);
00086 
00087   memset(str, 0x30, max_digits);
00088   str[max_digits] = 0x0;
00089 
00090   j = max_digits - 1;
00091 
00092   <span class="keywordflow">for</span> (i=0; i&lt;digit_count; i++)
00093   {
00094     <span class="keywordtype">char</span> no = 0;
00095     no = (number &amp; 0xf);
00096 
00097     <span class="keywordflow">if</span> ((no &gt;= 0x0) &amp;&amp; (no &lt;= 0x9))      no = <span class="charliteral">'0'</span>+no;
00098     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((no &gt;= 0xA) &amp;&amp; (no &lt;= 0xF)) no = <span class="charliteral">'A'</span>+ (no - 10);
00099 
00100     str[j--] = no;
00101     number &gt;&gt;= 4;
00102   }
00103 
00104   <span class="keywordflow">return</span> (0);
00105 }
00106 
00107 <span class="preprocessor">#define CVM_COMMON_LED_OUT(hexnum,digits) \</span>
00108 <span class="preprocessor">{ \</span>
00109 <span class="preprocessor">    char str[8+1]; \</span>
00110 <span class="preprocessor">    cvm_common_int2ascii_hex(hexnum, digits, str); \</span>
00111 <span class="preprocessor">    ebt3000_str_write(str); \</span>
00112 <span class="preprocessor">}</span>
00113 <span class="preprocessor"></span>
00114 <span class="preprocessor">#endif </span><span class="comment">/* REAL_HW */</span>
00115 
00116 
00117 <span class="comment">/* Linked buffer size setup at input */</span>
00118 
<a name="l00119"></a><a class="code" href="unioncvm__common__mbuf__size__t.html">00119</a> <span class="keyword">typedef</span> <span class="keyword">union </span>
00120 <span class="keyword"></span>{
<a name="l00121"></a><a class="code" href="unioncvm__common__mbuf__size__t.html#o0">00121</a>     uint64_t u64;
00122 
00123     <span class="keyword">struct </span>
00124 <span class="keyword">    </span>{
<a name="l00125"></a><a class="code" href="unioncvm__common__mbuf__size__t.html#o1">00125</a>         uint16_t mbuff_size;              <span class="comment">/* mbuff size in words */</span>
<a name="l00126"></a><a class="code" href="unioncvm__common__mbuf__size__t.html#o2">00126</a>         uint16_t mbuff_skip_first;        <span class="comment">/* skip for first mbuff */</span>
<a name="l00127"></a><a class="code" href="unioncvm__common__mbuf__size__t.html#o3">00127</a>         uint16_t mbuff_skip_not_first;    <span class="comment">/* skip for the rest of mbuffs */</span>
<a name="l00128"></a><a class="code" href="unioncvm__common__mbuf__size__t.html#o4">00128</a>         uint16_t initialized;             <span class="comment">/* set to 1 if this structure is initialized */</span>
00129     } s;
00130 } <a class="code" href="unioncvm__common__mbuf__size__t.html">cvm_common_mbuf_size_t</a>;
00131 
00132 
<a name="l00133"></a><a class="code" href="cvm-common-misc_8h.html#a30">00133</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-misc_8h.html#a30">cvm_common_get_max_buf_size</a>(cvmx_buf_ptr_t packet_ptr, <span class="keywordtype">int</span> bufs)
00134 {
00135     <span class="keywordtype">int</span> max_buf_size = 0;
00136 
00137     <a class="code" href="unioncvm__common__mbuf__size__t.html">cvm_common_mbuf_size_t</a> mbuf_info;
00138 
00139     mbuf_info.<a class="code" href="unioncvm__common__mbuf__size__t.html#o0">u64</a> = cvmx_scratch_read64(CVM_SCR_MBUFF_INFO_PTR);
00140 
00141     <span class="keywordflow">if</span> (bufs)
00142     {
00143         max_buf_size = (( mbuf_info.<a class="code" href="unioncvm__common__mbuf__size__t.html#o5">s</a>.mbuff_size &amp; 0xfff)
00144                       - ( (mbuf_info.<a class="code" href="unioncvm__common__mbuf__size__t.html#o5">s</a>.mbuff_skip_not_first &amp; 0x3f) + 1)) * 8;
00145     }
00146     <span class="keywordflow">else</span>
00147     {
00148         max_buf_size = ( (( mbuf_info.<a class="code" href="unioncvm__common__mbuf__size__t.html#o5">s</a>.mbuff_size &amp; 0xfff)
00149                        - (( mbuf_info.<a class="code" href="unioncvm__common__mbuf__size__t.html#o5">s</a>.mbuff_skip_first &amp; 0x3f) + 1) ) * 8)
00150                        - (packet_ptr.s.addr &amp; 0x7);
00151     }
00152 
00153     <span class="keywordflow">return</span> (max_buf_size);
00154 }
00155 
00156 
<a name="l00157"></a><a class="code" href="cvm-common-misc_8h.html#a31">00157</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-misc_8h.html#a31">cvm_common_fix_packet_size</a>(cvmx_wqe_t *swp)
00158 {
00159     <span class="keywordtype">int</span> remaining_len = cvmx_wqe_get_len(swp);
00160     <span class="keywordtype">int</span> i = 0;
00161     uint64_t raw_short_mask = 0x400000000ull;
00162     cvmx_buf_ptr_t *ptr=NULL;
00163     <span class="keywordtype">int</span> max_data = 0;
00164     <span class="keywordtype">int</span> current_data_len = 0;
00165 
00166     <span class="comment">/* check if the packet is from PCI - if it is raw short, don't do anything */</span>
00167     <span class="keywordflow">if</span> ( (swp-&gt;word2.s.software) &amp;&amp; ( ( (cvmx_wqe_get_port(swp) &gt;= 32) &amp;&amp; (cvmx_wqe_get_port(swp) &lt;= 35) ) ) )
00168     {
00169         <span class="comment">/* wqe is from the PCI */</span>
00170          uint64_t inst_hdr = swp-&gt;packet_data[0];
00171 
00172      <span class="keywordflow">if</span> ( inst_hdr &amp; raw_short_mask )
00173      {
00174          <span class="keywordflow">return</span> (0);
00175      }
00176     }
00177 
00178     <span class="comment">/* get the first pointer */</span>
00179     ptr = (cvmx_buf_ptr_t*)&amp;(swp-&gt;packet_ptr.u64);
00180 
00181     <span class="keywordflow">for</span> (i=0; i&lt;swp-&gt;word2.s.bufs; i++)
00182     {
00183         max_data = <a class="code" href="cvm-common-misc_8h.html#a30">cvm_common_get_max_buf_size</a>(*ptr, i);
00184         current_data_len = <a class="code" href="cvm-common-defs_8h.html#a106">cvm_common_imin</a>(remaining_len, max_data);
00185 
00186         ptr-&gt;s.size = current_data_len;
00187     remaining_len -= current_data_len;
00188 
00189     <span class="comment">/* update pointer if there are more links */</span>
00190     <span class="keywordflow">if</span> ( (i+1) &lt; swp-&gt;word2.s.bufs)
00191     {
00192         ptr = (cvmx_buf_ptr_t*)(((uint8_t *)cvmx_phys_to_ptr(ptr-&gt;s.addr))-8);
00193     }
00194     }
00195 
00196     <span class="keywordflow">return</span> (0);
00197 }
00198 
00199 <span class="comment">/* check the coremask for the last available core */</span>
<a name="l00200"></a><a class="code" href="cvm-common-misc_8h.html#a32">00200</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint8_t <a class="code" href="cvm-common-misc_8h.html#a32">cvm_common_get_last_core</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mask)
00201 {
00202    uint8_t i;
00203    uint8_t buf = 0;
00204                                                                                                                 
00205    <span class="keywordflow">for</span>(i=0;i&lt;16;i++) {
00206         <span class="keywordflow">if</span>(mask &amp; (1 &lt;&lt; i)) {
00207                 buf = i;
00208         }
00209    }
00210    <span class="keywordflow">return</span> buf;
00211 }
00212 
00213 
00214 
00215 <span class="comment">/* Global per core history  */</span>
<a name="l00216"></a><a class="code" href="cvm-common-misc_8h.html#a0">00216</a> <span class="preprocessor">#define CVM_COMMON_TRACE_MAX_ENTRIES    1000</span>
<a name="l00217"></a><a class="code" href="cvm-common-misc_8h.html#a1">00217</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_MAX_INFO_FIELDS 4</span>
<a name="l00218"></a><a class="code" href="cvm-common-misc_8h.html#a2">00218</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_ENTER       0</span>
<a name="l00219"></a><a class="code" href="cvm-common-misc_8h.html#a3">00219</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_BODY        1</span>
<a name="l00220"></a><a class="code" href="cvm-common-misc_8h.html#a4">00220</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_EXIT        2</span>
<a name="l00221"></a><a class="code" href="cvm-common-misc_8h.html#a5">00221</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_FNPTR       0</span>
<a name="l00222"></a><a class="code" href="cvm-common-misc_8h.html#a6">00222</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_NOT_FNPTR   1</span>
00223 <span class="preprocessor"></span>
00224 
<a name="l00225"></a><a class="code" href="cvm-common-misc_8h.html#a7">00225</a> <span class="preprocessor">#define CVM_COMMON_TRACE_MACRO_MARK_BUFFER_ALLOC     0x0</span>
<a name="l00226"></a><a class="code" href="cvm-common-misc_8h.html#a8">00226</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_MACRO_MARK_BUFFER_FREE      0x1</span>
00227 <span class="preprocessor"></span>
00228 <span class="keyword">extern</span> <span class="keywordtype">char</span>* <a class="code" href="cvm-common-misc_8h.html#a22">cvm_common_trace_macro_names</a>[];
00229 
<a name="l00230"></a><a class="code" href="struct__cvm__common__trace__entry.html">00230</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__cvm__common__trace__entry.html">_cvm_common_trace_entry</a>
00231 {
00232     <span class="keyword">union</span>
00233 <span class="keyword">    </span>{
<a name="l00234"></a><a class="code" href="struct__cvm__common__trace__entry.html#o0">00234</a>         uint64_t  <a class="code" href="struct__cvm__common__trace__entry.html#o0">u64</a>;
00235         <span class="keyword">struct</span>
00236 <span class="keyword">        </span>{
<a name="l00237"></a><a class="code" href="struct__cvm__common__trace__entry.html#o1">00237</a>             uint64_t   <a class="code" href="struct__cvm__common__trace__entry.html#o1">entry_exit</a>  : 2;
<a name="l00238"></a><a class="code" href="struct__cvm__common__trace__entry.html#o2">00238</a>             uint64_t   <a class="code" href="struct__cvm__common__trace__entry.html#o2">is_fn_ptr</a>   : 1;
<a name="l00239"></a><a class="code" href="struct__cvm__common__trace__entry.html#o3">00239</a>             uint64_t   <a class="code" href="struct__cvm__common__trace__entry.html#o3">info_count</a>  : 4;
<a name="l00240"></a><a class="code" href="struct__cvm__common__trace__entry.html#o4">00240</a>         uint64_t   <a class="code" href="struct__cvm__common__trace__entry.html#o4">unused</a>      : 5;
<a name="l00241"></a><a class="code" href="struct__cvm__common__trace__entry.html#o5">00241</a>             uint64_t   <a class="code" href="struct__cvm__common__trace__entry.html#o5">line_no</a>     : 12;
<a name="l00242"></a><a class="code" href="struct__cvm__common__trace__entry.html#o6">00242</a>             uint64_t   <a class="code" href="struct__cvm__common__trace__entry.html#o6">addr</a>        : 40;
00243         } <a class="code" href="struct__cvm__common__trace__entry.html#o7">s</a>;
00244     } <a class="code" href="struct__cvm__common__trace__entry.html#o8">trace_info</a>;
00245 
<a name="l00246"></a><a class="code" href="struct__cvm__common__trace__entry.html#o9">00246</a>     uint64_t <a class="code" href="struct__cvm__common__trace__entry.html#o9">cycles</a>;
<a name="l00247"></a><a class="code" href="struct__cvm__common__trace__entry.html#o10">00247</a>     uint64_t <a class="code" href="struct__cvm__common__trace__entry.html#o10">u_64_info</a>[<a class="code" href="cvm-common-misc_8h.html#a1">CVM_COMMON_TRACE_MAX_INFO_FIELDS</a>];
00248 
00249 } <a class="code" href="struct__cvm__common__trace__entry.html">cvm_common_trace_entry</a>;
00250 
<a name="l00251"></a><a class="code" href="struct__cvm__common__trace.html">00251</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__cvm__common__trace.html">_cvm_common_trace</a>
00252 {
<a name="l00253"></a><a class="code" href="struct__cvm__common__trace.html#o0">00253</a>     <span class="keywordtype">int</span> <a class="code" href="struct__cvm__common__trace.html#o0">cur_index</a>;
<a name="l00254"></a><a class="code" href="struct__cvm__common__trace.html#o1">00254</a>     <span class="keywordtype">int</span> <a class="code" href="struct__cvm__common__trace.html#o1">no_of_entries</a>;
<a name="l00255"></a><a class="code" href="struct__cvm__common__trace.html#o2">00255</a>     <a class="code" href="struct__cvm__common__trace__entry.html">cvm_common_trace_entry</a> <a class="code" href="struct__cvm__common__trace.html#o2">entry</a>[<a class="code" href="cvm-common-misc_8h.html#a0">CVM_COMMON_TRACE_MAX_ENTRIES</a>];
00256 } <a class="code" href="struct__cvm__common__trace.html">cvm_common_trace_t</a>;
00257 
00258 
<a name="l00259"></a><a class="code" href="struct__cvm__common__per__core__history.html">00259</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__cvm__common__per__core__history.html">_cvm_common_per_core_history</a> {
<a name="l00260"></a><a class="code" href="struct__cvm__common__per__core__history.html#o0">00260</a>     uint64_t <a class="code" href="struct__cvm__common__per__core__history.html#o0">current_cycle</a>;
00261 <span class="preprocessor">#ifdef CVM_FLOW_TRACE</span>
00262 <span class="preprocessor"></span>    <a class="code" href="struct__cvm__common__trace.html">cvm_common_trace_t</a> trace;
00263 <span class="preprocessor">#endif</span>
00264 <span class="preprocessor"></span>} <a class="code" href="struct__cvm__common__per__core__history.html">cvm_common_per_core_history_t</a>;
00265 
00266 
<a name="l00267"></a><a class="code" href="struct__cvm__common__history.html">00267</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__cvm__common__history.html">_cvm_common_history</a> {
<a name="l00268"></a><a class="code" href="struct__cvm__common__history.html#o0">00268</a>     <a class="code" href="struct__cvm__common__per__core__history.html">cvm_common_per_core_history_t</a> <a class="code" href="struct__cvm__common__history.html#o0">per_core_history</a>[CVMX_MAX_CORES];
00269 } <a class="code" href="struct__cvm__common__history.html">cvm_common_history_t</a>;
00270 
00271 <span class="keyword">extern</span> CVMX_SHARED <a class="code" href="struct__cvm__common__history.html">cvm_common_history_t</a> *<a class="code" href="cvm-common-misc_8h.html#a27">cvm_common_history</a>;
00272 
00273 <span class="comment">/* helping macros for common history */</span>
00274 <span class="preprocessor">#ifdef CVM_CLI_APP</span>
00275 <span class="preprocessor"></span>
00276 <span class="preprocessor">#define CVM_COMMON_HISTORY_SET_CYCLE() \</span>
00277 <span class="preprocessor">{ \</span>
00278 <span class="preprocessor">    if (cvm_common_history) \</span>
00279 <span class="preprocessor">    { \</span>
00280 <span class="preprocessor">        cvm_common_history-&gt;per_core_history[cvmx_get_core_num()].current_cycle = cvmx_get_cycle(); \</span>
00281 <span class="preprocessor">    } \</span>
00282 <span class="preprocessor">}</span>
00283 <span class="preprocessor"></span>
00284 <span class="preprocessor">#define CVM_COMMON_HISTORY_GET_CYCLE(core_num) \</span>
00285 <span class="preprocessor">({ \</span>
00286 <span class="preprocessor">    uint64_t c_val = 0; \</span>
00287 <span class="preprocessor">    if (cvm_common_history) \</span>
00288 <span class="preprocessor">    { \</span>
00289 <span class="preprocessor">        c_val = cvm_common_history-&gt;per_core_history[core_num].current_cycle; \</span>
00290 <span class="preprocessor">    } \</span>
00291 <span class="preprocessor">    c_val; \</span>
00292 <span class="preprocessor">})</span>
00293 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00294"></a><a class="code" href="cvm-common-misc_8h.html#a9">00294</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_HISTORY_SET_CYCLE() while(0);</span>
<a name="l00295"></a><a class="code" href="cvm-common-misc_8h.html#a10">00295</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_HISTORY_GET_CYCLE(core_num) \</span>
00296 <span class="preprocessor">({ \</span>
00297 <span class="preprocessor">    int c_val = 0; \</span>
00298 <span class="preprocessor">    c_val; \</span>
00299 <span class="preprocessor">})</span>
00300 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00301 <span class="preprocessor"></span>
00302 
00303 <span class="preprocessor">#endif </span><span class="comment">/* KERNEL */</span>
00304 
<a name="l00305"></a><a class="code" href="cvm-common-misc_8h.html#a33">00305</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-misc_8h.html#a33">cvm_common_buffer_init_fast</a>(<span class="keywordtype">void</span> *p, uint64_t size)
00306 {
00307    uint64_t num_cache_lines = ((size + (CVMX_CACHE_LINE_SIZE - 1)) / CVMX_CACHE_LINE_SIZE) &lt;&lt; 1;
00308    uint64_t *ptr = (uint64_t *) p;
00309    <span class="keywordflow">while</span>(num_cache_lines-- &gt; 0) {
00310       *ptr++ = 0x0L;
00311       *ptr++ = 0x0L;
00312       *ptr++ = 0x0L;
00313       *ptr++ = 0x0L;
00314       *ptr++ = 0x0L;
00315       *ptr++ = 0x0L;
00316       *ptr++ = 0x0L;
00317       *ptr++ = 0x0L;
00318    };
00319 }
00320 
00321 <span class="preprocessor">#if defined(CVM_CLI_APP) &amp;&amp; defined(CVM_FLOW_TRACE)</span>
00322 <span class="preprocessor"></span>
00323 <span class="preprocessor">#define CVM_COMMON_TRACE(entry_exit, is_fn_ptr, fn_addr)                             CVM_COMMON_TRACE_INFO (entry_exit, is_fn_ptr, fn_addr, 0, 0, 0, 0, 0)</span>
00324 <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_P1(entry_exit, is_fn_ptr, fn_addr, inf1)                    CVM_COMMON_TRACE_INFO (entry_exit, is_fn_ptr, fn_addr, 1, inf1, 0, 0, 0)</span>
00325 <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_P2(entry_exit, is_fn_ptr, fn_addr, inf1, inf2)              CVM_COMMON_TRACE_INFO (entry_exit, is_fn_ptr, fn_addr, 2, inf1, inf2, 0, 0)</span>
00326 <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_P3(entry_exit, is_fn_ptr, fn_addr, inf1, inf2, inf3)        CVM_COMMON_TRACE_INFO (entry_exit, is_fn_ptr, fn_addr, 3, inf1, inf2, inf3, 0)</span>
00327 <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_P4(entry_exit, is_fn_ptr, fn_addr, inf1, inf2, inf3, inf4)  CVM_COMMON_TRACE_INFO (entry_exit, is_fn_ptr, fn_addr, 4, inf1, inf2, inf3, inf4)</span>
00328 <span class="preprocessor"></span>
00329 
00330 <span class="preprocessor">#define CVM_COMMON_TRACE_INFO(t_entry_exit, t_is_fn_ptr, t_fn_addr, t_info_count, t_info1, t_info2, t_info3, t_info4) \</span>
00331 <span class="preprocessor">{ \</span>
00332 <span class="preprocessor">    uint64_t u64_trace_info=0; \</span>
00333 <span class="preprocessor">    int core_num = cvmx_get_core_num(); \</span>
00334 <span class="preprocessor">    int cur_index = cvm_common_history-&gt;per_core_history[core_num].trace.cur_index; \</span>
00335 <span class="preprocessor">    int entry_count = cvm_common_history-&gt;per_core_history[core_num].trace.no_of_entries; \</span>
00336 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.entry[cur_index].cycles = cvmx_get_cycle(); \</span>
00337 <span class="preprocessor">    u64_trace_info = ((((uint64_t)t_fn_addr)&amp;0x000000ffffffffffull) | \</span>
00338 <span class="preprocessor">                      ((((uint64_t)(__LINE__))&lt;&lt;40)&amp;0x000fff0000000000ull) | \</span>
00339 <span class="preprocessor">                      ((((uint64_t)(t_info_count))&lt;&lt;57)&amp;0x1e00000000000000ull) | \</span>
00340 <span class="preprocessor">                      ((((uint64_t)(t_is_fn_ptr))&lt;&lt;61)&amp;0x2000000000000000ull) | \</span>
00341 <span class="preprocessor">                      ((((uint64_t)(t_entry_exit))&lt;&lt;62)&amp;0xc000000000000000ull)); \</span>
00342 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.entry[cur_index].trace_info.u64 = u64_trace_info; \</span>
00343 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.entry[cur_index].trace_info.s.info_count = t_info_count; \</span>
00344 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.entry[cur_index].u_64_info[0] = (uint64_t)t_info1; \</span>
00345 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.entry[cur_index].u_64_info[1] = (uint64_t)t_info2; \</span>
00346 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.entry[cur_index].u_64_info[2] = (uint64_t)t_info3; \</span>
00347 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.entry[cur_index].u_64_info[3] = (uint64_t)t_info4; \</span>
00348 <span class="preprocessor">    cur_index++; \</span>
00349 <span class="preprocessor">    if (cur_index &gt;= CVM_COMMON_TRACE_MAX_ENTRIES) cur_index = 0; \</span>
00350 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.cur_index = cur_index; \</span>
00351 <span class="preprocessor">    if (entry_count &lt; CVM_COMMON_TRACE_MAX_ENTRIES) entry_count++; \</span>
00352 <span class="preprocessor">    cvm_common_history-&gt;per_core_history[core_num].trace.no_of_entries = entry_count; \</span>
00353 <span class="preprocessor">}</span>
00354 <span class="preprocessor"></span>
00355 <span class="preprocessor">#define CVM_COMMON_GET_HISTORY(core_num) ((cvm_common_trace_t*)(&amp;cvm_common_history-&gt;per_core_history[core_num].trace))</span>
00356 <span class="preprocessor"></span>
00357 <span class="preprocessor">#else</span>
<a name="l00358"></a><a class="code" href="cvm-common-misc_8h.html#a11">00358</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE(entry_exit, is_fn_ptr, fn_addr);</span>
<a name="l00359"></a><a class="code" href="cvm-common-misc_8h.html#a12">00359</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_P1(entry_exit, is_fn_ptr, fn_addr, inf1);</span>
<a name="l00360"></a><a class="code" href="cvm-common-misc_8h.html#a13">00360</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_P2(entry_exit, is_fn_ptr, fn_addr, inf1, inf2);</span>
<a name="l00361"></a><a class="code" href="cvm-common-misc_8h.html#a14">00361</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_P3(entry_exit, is_fn_ptr, fn_addr, inf1, inf2, inf3);</span>
<a name="l00362"></a><a class="code" href="cvm-common-misc_8h.html#a15">00362</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_P4(entry_exit, is_fn_ptr, fn_addr, inf1, inf2, inf3, inf4);</span>
<a name="l00363"></a><a class="code" href="cvm-common-misc_8h.html#a16">00363</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_TRACE_INFO(t_entry_exit, t_is_fn_ptr, t_fn_addr, t_info_count, t_info1, t_info2, t_info3, t_info4);</span>
<a name="l00364"></a><a class="code" href="cvm-common-misc_8h.html#a17">00364</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_GET_HISTORY(core_num);</span>
00365 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00366 <span class="preprocessor"></span>
00367 
00368 <span class="preprocessor">#ifdef EXTRA_STATS</span>
00369 <span class="preprocessor"></span>
00370 <span class="preprocessor">#define CVM_COMMON_EXTRA_STATS_ADD32(fau, val)   cvmx_fau_atomic_add32 ( (fau), (val) )</span>
00371 <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_EXTRA_STATS_ADD64(fau, val)   cvmx_fau_atomic_add64 ( (fau), (val) )</span>
00372 <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_EXTRA_STATS_GET32(fau) \</span>
00373 <span class="preprocessor">({ \</span>
00374 <span class="preprocessor">    uint32_t retval = 0; \</span>
00375 <span class="preprocessor">    retval = cvmx_fau_fetch_and_add32 (fau, 0); \</span>
00376 <span class="preprocessor">    retval; \</span>
00377 <span class="preprocessor">})</span>
00378 <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_EXTRA_STATS_GET64(fau) \</span>
00379 <span class="preprocessor">({ \</span>
00380 <span class="preprocessor">    uint64_t retval = 0; \</span>
00381 <span class="preprocessor">    retval = cvmx_fau_fetch_and_add64 (fau, 0); \</span>
00382 <span class="preprocessor">    retval; \</span>
00383 <span class="preprocessor">})</span>
00384 <span class="preprocessor"></span>
00385 <span class="preprocessor">#else</span>
00386 <span class="preprocessor"></span>
<a name="l00387"></a><a class="code" href="cvm-common-misc_8h.html#a18">00387</a> <span class="preprocessor">#define CVM_COMMON_EXTRA_STATS_ADD32(fau, val);</span>
<a name="l00388"></a><a class="code" href="cvm-common-misc_8h.html#a19">00388</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_EXTRA_STATS_ADD64(fau, val);</span>
<a name="l00389"></a><a class="code" href="cvm-common-misc_8h.html#a20">00389</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_EXTRA_STATS_GET32(fau) \</span>
00390 <span class="preprocessor">({ \</span>
00391 <span class="preprocessor">    uint32_t retval = 0; \</span>
00392 <span class="preprocessor">    retval; \</span>
00393 <span class="preprocessor">})</span>
<a name="l00394"></a><a class="code" href="cvm-common-misc_8h.html#a21">00394</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_EXTRA_STATS_GET64(fau) \</span>
00395 <span class="preprocessor">({ \</span>
00396 <span class="preprocessor">    uint64_t retval = 0; \</span>
00397 <span class="preprocessor">    retval; \</span>
00398 <span class="preprocessor">})</span>
00399 <span class="preprocessor"></span>
00400 <span class="preprocessor">#endif </span><span class="comment">/* #ifdef EXTRA_STATS */</span>
00401 
00402 
00403 <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-misc_8h.html#a34">cvm_common_packet_copy</a> (cvmx_buf_ptr_t *ptr_to, cvmx_buf_ptr_t *ptr_from, <span class="keywordtype">int</span> num_bufs, <span class="keywordtype">int</span> total_len);
00404 <span class="keywordtype">int</span>  <a class="code" href="cvm-common-misc_8h.html#a35">cvm_common_swp_packet_copy</a>(<a class="code" href="structcvm__common__wqe.html">cvm_common_wqe_t</a> **swp_to, <a class="code" href="structcvm__common__wqe.html">cvm_common_wqe_t</a> *swp_from);
00405 <span class="keywordtype">void</span> <a class="code" href="cvm-common-misc_8h.html#a36">cvm_common_packet_ptr_dump</a>(<a class="code" href="structcvm__common__wqe.html">cvm_common_wqe_t</a> *swp);
00406 <span class="keywordtype">void</span> <a class="code" href="cvm-common-misc_8h.html#a37">cvm_common_gather_list_dump</a>(<a class="code" href="structcvm__common__wqe.html">cvm_common_wqe_t</a> *swp);
00407 
00408 <span class="preprocessor">#endif </span><span class="comment">/* __CVM_COMMON_MISC_H__ */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Oct 25 14:15:48 2011 for Octeon Common Component by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
