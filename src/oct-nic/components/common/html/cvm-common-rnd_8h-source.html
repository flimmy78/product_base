<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Octeon Common Component: cvm-common-rnd.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>cvm-common-rnd.h</h1><a href="cvm-common-rnd_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/***********************************************************************</span>
00002 <span class="comment"></span>
00003 <span class="comment">  OCTEON TOOLKITS                                                         </span>
00004 <span class="comment">  Copyright (c) 2007 Cavium Networks. All rights reserved.</span>
00005 <span class="comment"></span>
00006 <span class="comment">  This file, which is part of the OCTEON TOOLKIT from Cavium Networks,</span>
00007 <span class="comment">  contains proprietary and confidential information of Cavium Networks</span>
00008 <span class="comment">  and in some cases its suppliers.</span>
00009 <span class="comment"></span>
00010 <span class="comment">  Any licensed reproduction, distribution, modification, or other use of</span>
00011 <span class="comment">  this file or confidential information embodied in this file is subject</span>
00012 <span class="comment">  to your license agreement with Cavium Networks. The applicable license</span>
00013 <span class="comment">  terms can be found by contacting Cavium Networks or the appropriate</span>
00014 <span class="comment">  representative within your company.</span>
00015 <span class="comment"></span>
00016 <span class="comment">  All other use and disclosure is prohibited.</span>
00017 <span class="comment"></span>
00018 <span class="comment">  Contact Cavium Networks at info@caviumnetworks.com for more information.</span>
00019 <span class="comment"></span>
00020 <span class="comment"> ************************************************************************/</span> 
00021 
00022 <span class="preprocessor">#ifndef __CVM_COMMON_RNDC_H__</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#define __CVM_COMMON_RNDC_H__</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#include &lt;cvmx-rng.h&gt;</span>
00026 
00027 
<a name="l00028"></a><a class="code" href="struct__cvm__common__rand__state.html">00028</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__cvm__common__rand__state.html">_cvm_common_rand_state</a> {
<a name="l00029"></a><a class="code" href="struct__cvm__common__rand__state.html#o0">00029</a>     uint64_t <a class="code" href="struct__cvm__common__rand__state.html#o0">rand_state_key0</a>;
<a name="l00030"></a><a class="code" href="struct__cvm__common__rand__state.html#o1">00030</a>     uint64_t <a class="code" href="struct__cvm__common__rand__state.html#o1">rand_state_key1</a>;
<a name="l00031"></a><a class="code" href="struct__cvm__common__rand__state.html#o2">00031</a>     uint64_t <a class="code" href="struct__cvm__common__rand__state.html#o2">rand_state_key2</a>;
<a name="l00032"></a><a class="code" href="struct__cvm__common__rand__state.html#o3">00032</a>     uint64_t <a class="code" href="struct__cvm__common__rand__state.html#o3">rand_state_v</a>;
<a name="l00033"></a><a class="code" href="struct__cvm__common__rand__state.html#o4">00033</a>     uint64_t <a class="code" href="struct__cvm__common__rand__state.html#o4">rand_state_i</a>;
00034 } <a class="code" href="struct__cvm__common__rand__state.html">cvm_common_rand_state_t</a>;
00035 
00036 
00037 
00038 
00039  
00040 <span class="comment">/* must be executed by a single core during global init */</span>
<a name="l00041"></a><a class="code" href="cvm-common-rnd_8h.html#a1">00041</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-rnd_8h.html#a1">cvm_common_hw_rand_init</a>(<span class="keywordtype">void</span>)
00042 {
00043 <span class="preprocessor">#if defined(__KERNEL__) &amp;&amp; defined(linux)</span>
00044 <span class="preprocessor"></span>    set_c0_status(ST0_CU2);
00045 <span class="preprocessor">#endif</span>
00046 <span class="preprocessor"></span>
00047     cvmx_rng_enable();
00048 } 
00049 
00050 
00051 <span class="comment">/* do not call before cvm_common_hw_rand_init() */</span>
<a name="l00052"></a><a class="code" href="cvm-common-rnd_8h.html#a2">00052</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-rnd_8h.html#a2">cvm_common_hw_rand</a>( uint8_t *output, <span class="keywordtype">int</span> length )
00053 {
00054     uint64_t out;
00055 
00056 <span class="preprocessor">#if defined(__KERNEL__) &amp;&amp; defined(linux)</span>
00057 <span class="preprocessor"></span>    set_c0_status(ST0_CU2);
00058 <span class="preprocessor">#endif</span>
00059 <span class="preprocessor"></span>
00060     <span class="keywordflow">while</span> (length &gt;= 8) 
00061     { 
00062         *(uint64_t*)output = cvmx_rng_get_random64();
00063         length-=8 ;
00064         output+=8;
00065     }
00066     <span class="comment">/* check remaining non-8-byte boundary */</span>
00067     <span class="keywordflow">if</span> (length) 
00068     {
00069         out = cvmx_rng_get_random64();
00070         *(uint64_t*)output = out &gt;&gt; (64 - (length&lt;&lt;3));
00071     }
00072 
00073     <span class="keywordflow">return</span>;    
00074 }
00075 
00076 
00077 <span class="comment">/* random externs */</span>
00078 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-rnd_8h.html#a1">cvm_common_hw_rand_init</a>(<span class="keywordtype">void</span>);
00079 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-rnd_8h.html#a2">cvm_common_hw_rand</a>( uint8_t *output, <span class="keywordtype">int</span> length );
00080 
00081 
<a name="l00082"></a><a class="code" href="cvm-common-rnd_8h.html#a3">00082</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-rnd_8h.html#a3">cvm_common_rand8_init</a>(<a class="code" href="struct__cvm__common__rand__state.html">cvm_common_rand_state_t</a> *rstate)
00083 {   
00084     uint64_t dt;
00085     uint64_t <span class="keywordtype">id</span> = cvmx_get_core_num();
00086     <a class="code" href="cvm-common-rnd_8h.html#a2">cvm_common_hw_rand</a>((uint8_t *)&amp;dt, 8);
00087     dt += id;
00088     <a class="code" href="cvm-common-rnd_8h.html#a2">cvm_common_hw_rand</a>((uint8_t *)&amp;(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o0">rand_state_key0</a>), 8);
00089     rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o0">rand_state_key0</a> += id;
00090     <a class="code" href="cvm-common-rnd_8h.html#a2">cvm_common_hw_rand</a>((uint8_t *)&amp;(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o1">rand_state_key1</a>), 8);
00091     rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o1">rand_state_key1</a> += id;
00092     <a class="code" href="cvm-common-rnd_8h.html#a2">cvm_common_hw_rand</a>((uint8_t *)&amp;(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o2">rand_state_key2</a>), 8);
00093     rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o2">rand_state_key2</a> += id;
00094     <a class="code" href="cvm-common-rnd_8h.html#a2">cvm_common_hw_rand</a>((uint8_t *)&amp;(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o3">rand_state_v</a>), 8);
00095     rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o3">rand_state_v</a> += id;
00096 
00097 <span class="preprocessor">#ifndef OCTEON_EXP</span>
00098 <span class="preprocessor"></span>    
00099 <span class="preprocessor">#if defined(__KERNEL__) &amp;&amp; defined(linux)</span>
00100 <span class="preprocessor"></span>    set_c0_status(ST0_CU2);
00101 <span class="preprocessor">#endif</span>
00102 <span class="preprocessor"></span>
00103     CVMX_MT_3DES_IV(0);
00104     CVMX_MT_3DES_KEY(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o0">rand_state_key0</a>, 0);
00105     CVMX_MT_3DES_KEY(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o1">rand_state_key1</a>, 1);
00106     CVMX_MT_3DES_KEY(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o2">rand_state_key2</a>, 2);
00107     CVMX_MT_3DES_ENC_CBC(dt);
00108     CVMX_MF_3DES_RESULT(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o4">rand_state_i</a>);
00109 <span class="preprocessor">#endif</span>
00110 <span class="preprocessor"></span>}
00111 
00112 <span class="comment">/* returns 8 bytes of random data -- based on ANSI X9.31 */</span>
<a name="l00113"></a><a class="code" href="cvm-common-rnd_8h.html#a4">00113</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint64_t <a class="code" href="cvm-common-rnd_8h.html#a4">cvm_common_rand8</a>(<a class="code" href="struct__cvm__common__rand__state.html">cvm_common_rand_state_t</a> *rstate)
00114 {
00115     uint64_t r;
00116 
00117 <span class="preprocessor">#ifdef OCTEON_EXP</span>
00118 <span class="preprocessor"></span>    r = cvmx_rng_get_random64();
00119     <span class="keywordflow">return</span> (r);
00120 <span class="preprocessor">#else</span>
00121 <span class="preprocessor"></span>
00122 <span class="preprocessor">#if defined(__KERNEL__) &amp;&amp; defined(linux)</span>
00123 <span class="preprocessor"></span>    set_c0_status(ST0_CU2);
00124 <span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span>
00126     CVMX_MT_3DES_KEY(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o0">rand_state_key0</a>, 0);
00127     CVMX_MT_3DES_KEY(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o1">rand_state_key1</a>, 1);
00128     CVMX_MT_3DES_KEY(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o2">rand_state_key2</a>, 2);
00129  try_again:
00130     CVMX_MT_3DES_IV(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o3">rand_state_v</a>);
00131     CVMX_MT_3DES_ENC_CBC(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o4">rand_state_i</a>);
00132     CVMX_MF_3DES_RESULT(r);
00133     CVMX_MT_3DES_ENC_CBC(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o4">rand_state_i</a>);
00134     CVMX_MF_3DES_RESULT(rstate-&gt;<a class="code" href="struct__cvm__common__rand__state.html#o3">rand_state_v</a>);
00135     <span class="keywordflow">if</span> (r != 0)
00136     {
00137         <span class="keywordflow">return</span> (r);
00138     }
00139     <span class="keywordflow">else</span>
00140     {
00141         <span class="keywordflow">goto</span> try_again;
00142     }
00143 <span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>}
00145 
00146 <span class="preprocessor">#endif </span><span class="comment">/* __CVM_COMMON_RND_H__ */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Oct 25 14:15:48 2011 for Octeon Common Component by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
