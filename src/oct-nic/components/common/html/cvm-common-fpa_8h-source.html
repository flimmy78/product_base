<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Octeon Common Component: cvm-common-fpa.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>cvm-common-fpa.h</h1><a href="cvm-common-fpa_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/***********************************************************************</span>
00002 <span class="comment"></span>
00003 <span class="comment">  OCTEON TOOLKITS                                                         </span>
00004 <span class="comment">  Copyright (c) 2007 Cavium Networks. All rights reserved.</span>
00005 <span class="comment"></span>
00006 <span class="comment">  This file, which is part of the OCTEON TOOLKIT from Cavium Networks,</span>
00007 <span class="comment">  contains proprietary and confidential information of Cavium Networks</span>
00008 <span class="comment">  and in some cases its suppliers.</span>
00009 <span class="comment"></span>
00010 <span class="comment">  Any licensed reproduction, distribution, modification, or other use of</span>
00011 <span class="comment">  this file or confidential information embodied in this file is subject</span>
00012 <span class="comment">  to your license agreement with Cavium Networks. The applicable license</span>
00013 <span class="comment">  terms can be found by contacting Cavium Networks or the appropriate</span>
00014 <span class="comment">  representative within your company.</span>
00015 <span class="comment"></span>
00016 <span class="comment">  All other use and disclosure is prohibited.</span>
00017 <span class="comment"></span>
00018 <span class="comment">  Contact Cavium Networks at info@caviumnetworks.com for more information.</span>
00019 <span class="comment"></span>
00020 <span class="comment"> ************************************************************************/</span> 
00021 
00022 <span class="preprocessor">#ifndef __CVM_COMMON_FPA_H__</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#define __CVM_COMMON_FPA_H__</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#include "cvmx.h"</span>
00026 
00027 <span class="preprocessor">#if defined (__KERNEL__)</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#include &lt;linux/kernel.h&gt;</span>
00030 <span class="preprocessor">#include &lt;linux/uio.h&gt;</span>
00031 <span class="preprocessor">#include &lt;asm-generic/memory_model.h&gt;</span>
00032 <span class="preprocessor">#undef printf</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/mm.h&gt;</span>
00034 <span class="preprocessor">#define printf printk</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#include &lt;asm-mips/page.h&gt;</span>
00036 <span class="preprocessor">#include &lt;linux/mm_types.h&gt;</span>
00037 
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
00040 <span class="preprocessor">#include "cvmx-fau.h"</span>
00041 
00042 <span class="preprocessor">#if !defined(__KERNEL__)</span>
00043 <span class="preprocessor"></span>
00044 <span class="comment">/* structure to hold fpa buffer information */</span>
00045 
<a name="l00046"></a><a class="code" href="cvm-common-fpa_8h.html#a0">00046</a> <span class="preprocessor">#define CVM_COMMON_MAX_FPA_INFO_ENTRIES 5</span>
00047 <span class="preprocessor"></span>
<a name="l00048"></a><a class="code" href="struct__cvm__common__fpa__info__entry.html">00048</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__cvm__common__fpa__info__entry.html">_cvm_common_fpa_info_entry</a> {
<a name="l00049"></a><a class="code" href="struct__cvm__common__fpa__info__entry.html#o0">00049</a>     uint64_t <a class="code" href="struct__cvm__common__fpa__info__entry.html#o0">start_addr</a>;
<a name="l00050"></a><a class="code" href="struct__cvm__common__fpa__info__entry.html#o1">00050</a>     uint64_t <a class="code" href="struct__cvm__common__fpa__info__entry.html#o1">end_addr</a>;
<a name="l00051"></a><a class="code" href="struct__cvm__common__fpa__info__entry.html#o2">00051</a>     uint64_t <a class="code" href="struct__cvm__common__fpa__info__entry.html#o2">element_size</a>;
<a name="l00052"></a><a class="code" href="struct__cvm__common__fpa__info__entry.html#o3">00052</a>     uint64_t <a class="code" href="struct__cvm__common__fpa__info__entry.html#o3">info_base</a>;
00053 } <a class="code" href="struct__cvm__common__fpa__info__entry.html">cvm_common_fpa_info_entry_t</a>;
00054 
<a name="l00055"></a><a class="code" href="struct__cvm__common__fpa__info.html">00055</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__cvm__common__fpa__info.html">_cvm_common_fpa_info</a> {
<a name="l00056"></a><a class="code" href="struct__cvm__common__fpa__info.html#o0">00056</a>     <span class="keywordtype">int</span> <a class="code" href="struct__cvm__common__fpa__info.html#o0">count</a>;
<a name="l00057"></a><a class="code" href="struct__cvm__common__fpa__info.html#o1">00057</a>     <span class="keywordtype">int</span> <a class="code" href="struct__cvm__common__fpa__info.html#o1">unused</a>;
<a name="l00058"></a><a class="code" href="struct__cvm__common__fpa__info.html#o2">00058</a>     <a class="code" href="struct__cvm__common__fpa__info__entry.html">cvm_common_fpa_info_entry_t</a> <a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[<a class="code" href="cvm-common-fpa_8h.html#a0">CVM_COMMON_MAX_FPA_INFO_ENTRIES</a>];
00059 } <a class="code" href="struct__cvm__common__fpa__info.html">cvm_common_fpa_info_t</a>;
00060 
00061 <span class="comment">/* fpa information */</span>
00062 <span class="keyword">extern</span> <a class="code" href="struct__cvm__common__fpa__info.html">cvm_common_fpa_info_t</a> <a class="code" href="cvm-common-fpa_8h.html#a22">cvm_common_fpa_info</a>[CVMX_FPA_NUM_POOLS];
00063 
00064 
00065 
00066 
00067 
00068 <span class="preprocessor">#ifdef FPA_SANITY_BREAKPOINT</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_BREAK asm volatile ("sdbbp 1");</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00071"></a><a class="code" href="cvm-common-fpa_8h.html#a1">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_BREAK </span>
00072 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00073 <span class="preprocessor"></span>
00074 
00075 
00076 <span class="keyword">extern</span> CVMX_SHARED <span class="keywordtype">char</span> <a class="code" href="cvm-common-fpa_8h.html#a23">pools_initialized</a>;
00077 <span class="comment"></span>
00078 <span class="comment">/** Add FPA allocated memory information</span>
00079 <span class="comment"> *</span>
00080 <span class="comment"> *  @param pool       - FPA pool number</span>
00081 <span class="comment"> *  @param buffer     - pointer to the start address of the allocated memory</span>
00082 <span class="comment"> *  @param block_size - size of each individual buffer in this pool (in bytes)</span>
00083 <span class="comment"> *  @param num_blocks - number of buffers allocated</span>
00084 <span class="comment"> *  @param base       - address of extra memory allocated to keep track of FPA buffers</span>
00085 <span class="comment"> *</span>
00086 <span class="comment"> * This function is used to add the FPA allocated </span>
00087 <span class="comment"> * information to future reference.</span>
00088 <span class="comment"> *</span>
00089 <span class="comment"> * Note that this function should be called at</span>
00090 <span class="comment"> * the initializations time by the boot core.</span>
00091 <span class="comment"> *</span>
00092 <span class="comment"> */</span>
<a name="l00093"></a><a class="code" href="cvm-common-fpa_8h.html#a24">00093</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-fpa_8h.html#a24">cvm_common_fpa_add_pool_info</a>(uint64_t pool, <span class="keywordtype">void</span>* buffer, uint64_t block_size, uint64_t num_blocks, uint64_t base)
00094 {
00095     <span class="keywordtype">int</span> ptr = 0;
00096 
00097     <span class="keywordflow">if</span> (!<a class="code" href="cvm-common-fpa_8h.html#a23">pools_initialized</a>)
00098     {
00099         <span class="keywordtype">int</span> k = 0;
00100     <span class="keywordflow">for</span> (k=0; k&lt;CVMX_FPA_NUM_POOLS; k++) cvm_common_fpa_info[k].<a class="code" href="struct__cvm__common__fpa__info.html#o0">count</a> = 0;
00101 
00102         <a class="code" href="cvm-common-fpa_8h.html#a23">pools_initialized</a> = 1;
00103     }
00104 
00105     <span class="keywordflow">if</span> (!buffer)
00106     {
00107         printf(<span class="stringliteral">"ERROR: cvm_fpa_add_pool: NULL buffer pointer!\n"</span>);
00108         <span class="keywordflow">return</span>(-1);
00109     }
00110     <span class="keywordflow">if</span> (pool &gt;= CVMX_FPA_NUM_POOLS)
00111     {
00112         printf(<span class="stringliteral">"ERROR: cvm_fpa_add_pool: Illegal pool!\n"</span>);
00113         <span class="keywordflow">return</span>(-1);
00114     }
00115     <span class="keywordflow">if</span> (block_size &lt; CVMX_FPA_MIN_BLOCK_SIZE)
00116     {
00117         printf(<span class="stringliteral">"ERROR: cvm_fpa_add_pool: Block size too small.\n"</span>);
00118         <span class="keywordflow">return</span>(-1);
00119     }
00120 
00121     <span class="keywordflow">if</span> (cvm_common_fpa_info[pool].count == <a class="code" href="cvm-common-fpa_8h.html#a0">CVM_COMMON_MAX_FPA_INFO_ENTRIES</a>)
00122     {
00123         printf(<span class="stringliteral">"ERROR: cvm_fpa_add_pool: No more space for pool %lld to hold another entry!\n"</span>, CAST64(pool));
00124         <span class="keywordflow">return</span>(-1);
00125     }
00126 
00127     ptr = cvm_common_fpa_info[pool].<a class="code" href="struct__cvm__common__fpa__info.html#o0">count</a>;
00128     cvm_common_fpa_info[pool].<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[ptr].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o0">start_addr</a> = CAST64(buffer);
00129     cvm_common_fpa_info[pool].<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[ptr].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o1">end_addr</a>   = (CAST64(buffer) + (block_size*num_blocks))-1;
00130     cvm_common_fpa_info[pool].<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[ptr].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o2">element_size</a> = block_size;
00131     cvm_common_fpa_info[pool].<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[ptr].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o3">info_base</a> = base;
00132     ptr++;
00133     cvm_common_fpa_info[pool].<a class="code" href="struct__cvm__common__fpa__info.html#o0">count</a> = ptr;
00134 
00135     <span class="keywordflow">return</span> (0);
00136 }
00137 
00138 
<a name="l00139"></a><a class="code" href="cvm-common-fpa_8h.html#a25">00139</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-fpa_8h.html#a25">cvm_common_fpa_display_pool_info</a>(uint64_t pool)
00140 {
00141     <span class="keywordtype">int</span> i=0;
00142     <a class="code" href="struct__cvm__common__fpa__info.html">cvm_common_fpa_info_t</a> pool_info = cvm_common_fpa_info[pool];
00143 
00144     printf(<span class="stringliteral">"POOL %lld (each buffer is %lld bytes):\n"</span>, CAST64(pool), CAST64(pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[0].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o2">element_size</a>));
00145     <span class="keywordflow">for</span> (i=0; i&lt;pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o0">count</a>; i++)
00146     {
00147       printf(<span class="stringliteral">"  [%d] : start = 0x%llX,  end = 0x%llX, entries = %lld\n"</span>,
00148              i, 
00149              CAST64(pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[i].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o0">start_addr</a>), 
00150          CAST64(pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[i].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o1">end_addr</a>),
00151              CAST64((pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[i].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o1">end_addr</a>- pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[i].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o0">start_addr</a>+1)/pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[0].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o2">element_size</a>));
00152     }
00153 
00154     printf(<span class="stringliteral">"\n"</span>);
00155 
00156     <span class="keywordflow">return</span> (0);
00157 }
00158 
00159 <span class="comment"></span>
00160 <span class="comment">/** Display FPA allocated memory information</span>
00161 <span class="comment"> *</span>
00162 <span class="comment"> * This function displays various FPA allocated</span>
00163 <span class="comment"> * pools and their corresponding memory usage</span>
00164 <span class="comment"> *</span>
00165 <span class="comment"> */</span>
<a name="l00166"></a><a class="code" href="cvm-common-fpa_8h.html#a26">00166</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-fpa_8h.html#a26">cvm_common_fpa_display_all_pool_info</a>(<span class="keywordtype">void</span>)
00167 {
00168     <span class="keywordtype">int</span> i = 0;
00169     <span class="keywordflow">for</span> (i=0; i&lt;CVMX_FPA_NUM_POOLS; i++)
00170     {
00171         <span class="keywordflow">if</span> (cvm_common_fpa_info[i].count)
00172     {
00173             <a class="code" href="cvm-common-fpa_8h.html#a25">cvm_common_fpa_display_pool_info</a>(i);
00174     }
00175     }
00176 
00177     <span class="keywordflow">return</span> (0);
00178 }
00179 
00180 
<a name="l00181"></a><a class="code" href="cvm-common-fpa_8h.html#a27">00181</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-fpa_8h.html#a27">cvm_common_fpa_find_pool</a> (uint64_t ptr, uint64_t *size)
00182 {
00183     <span class="keywordtype">int</span> pool = -1;
00184     <a class="code" href="struct__cvm__common__fpa__info.html">cvm_common_fpa_info_t</a> pool_info; 
00185     
00186     <span class="keywordflow">for</span> (pool=0; pool&lt;CVMX_FPA_NUM_POOLS; pool++)
00187     {
00188         pool_info = cvm_common_fpa_info[pool];
00189     
00190     <span class="keywordflow">if</span> ( (uint64_t)CAST64(cvmx_phys_to_ptr(ptr)) &gt;= pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[pool].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o0">start_addr</a> &amp;&amp;
00191          (uint64_t)CAST64(cvmx_phys_to_ptr(ptr)) &lt;= pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[pool].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o1">end_addr</a>) 
00192         {
00193             *size = pool_info.<a class="code" href="struct__cvm__common__fpa__info.html#o2">entry</a>[pool].<a class="code" href="struct__cvm__common__fpa__info__entry.html#o2">element_size</a>; 
00194 
00195         <span class="keywordflow">return</span> (pool);
00196     }
00197     }
00198 
00199     <a class="code" href="cvm-common-defs_8h.html#a39">CVM_COMMON_SIMPRINTF</a> (<span class="stringliteral">"cvm_common_fpa_find_pool: address: 0x%llx not found in any pool\n"</span>, CAST64(cvmx_phys_to_ptr(ptr)));
00200     <span class="keywordflow">return</span> (pool);
00201 }
00202 
<a name="l00203"></a><a class="code" href="cvm-common-fpa_8h.html#a2">00203</a> <span class="preprocessor">#define CVM_COMMON_FPA_AVAIL_COUNT(pool) cvmx_read_csr(CVMX_FPA_QUEX_AVAILABLE(pool))</span>
00204 <span class="preprocessor"></span>
<a name="l00205"></a><a class="code" href="cvm-common-fpa_8h.html#a3">00205</a> <span class="preprocessor">#define CVM_COMMON_GET_FPA_USE_COUNT(pool) \</span>
00206 <span class="preprocessor">({ \</span>
00207 <span class="preprocessor">    uint32_t count = 0; \</span>
00208 <span class="preprocessor">    switch(pool) \</span>
00209 <span class="preprocessor">    { \</span>
00210 <span class="preprocessor">        case 0:  \</span>
00211 <span class="preprocessor">            count = cvmx_fau_fetch_and_add32(CVM_FAU_REG_POOL_0_USE_COUNT, 0); \</span>
00212 <span class="preprocessor">            break; \</span>
00213 <span class="preprocessor">        case 1:  \</span>
00214 <span class="preprocessor">            count = cvmx_fau_fetch_and_add32(CVM_FAU_REG_POOL_1_USE_COUNT, 0); \</span>
00215 <span class="preprocessor">            break; \</span>
00216 <span class="preprocessor">        case 2:  \</span>
00217 <span class="preprocessor">            count = cvmx_fau_fetch_and_add32(CVM_FAU_REG_POOL_2_USE_COUNT, 0); \</span>
00218 <span class="preprocessor">            break; \</span>
00219 <span class="preprocessor">        case 3:  \</span>
00220 <span class="preprocessor">            count = cvmx_fau_fetch_and_add32(CVM_FAU_REG_POOL_3_USE_COUNT, 0); \</span>
00221 <span class="preprocessor">            break; \</span>
00222 <span class="preprocessor">        case 4:  \</span>
00223 <span class="preprocessor">            count = cvmx_fau_fetch_and_add32(CVM_FAU_REG_POOL_4_USE_COUNT, 0); \</span>
00224 <span class="preprocessor">            break; \</span>
00225 <span class="preprocessor">        case 5:  \</span>
00226 <span class="preprocessor">            count = cvmx_fau_fetch_and_add32(CVM_FAU_REG_POOL_5_USE_COUNT, 0); \</span>
00227 <span class="preprocessor">            break; \</span>
00228 <span class="preprocessor">        case 6:  \</span>
00229 <span class="preprocessor">            count = cvmx_fau_fetch_and_add32(CVM_FAU_REG_POOL_6_USE_COUNT, 0); \</span>
00230 <span class="preprocessor">            break; \</span>
00231 <span class="preprocessor">        case 7:  \</span>
00232 <span class="preprocessor">            count = cvmx_fau_fetch_and_add32(CVM_FAU_REG_POOL_7_USE_COUNT, 0); \</span>
00233 <span class="preprocessor">            break; \</span>
00234 <span class="preprocessor">    } \</span>
00235 <span class="preprocessor">    count;\</span>
00236 <span class="preprocessor">})</span>
00237 <span class="preprocessor"></span>
<a name="l00238"></a><a class="code" href="cvm-common-fpa_8h.html#a4">00238</a> <span class="preprocessor">#define CVM_COMMON_FPA_USE_COUNT_ADD(pool, val) \</span>
00239 <span class="preprocessor">{ \</span>
00240 <span class="preprocessor">    switch(pool) \</span>
00241 <span class="preprocessor">    { \</span>
00242 <span class="preprocessor">        case 0:  \</span>
00243 <span class="preprocessor">            cvmx_fau_atomic_add32(CVM_FAU_REG_POOL_0_USE_COUNT, val); \</span>
00244 <span class="preprocessor">            break; \</span>
00245 <span class="preprocessor">        case 1:  \</span>
00246 <span class="preprocessor">            cvmx_fau_atomic_add32(CVM_FAU_REG_POOL_1_USE_COUNT, val); \</span>
00247 <span class="preprocessor">            break; \</span>
00248 <span class="preprocessor">        case 2:  \</span>
00249 <span class="preprocessor">            cvmx_fau_atomic_add32(CVM_FAU_REG_POOL_2_USE_COUNT, val); \</span>
00250 <span class="preprocessor">            break; \</span>
00251 <span class="preprocessor">        case 3:  \</span>
00252 <span class="preprocessor">            cvmx_fau_atomic_add32(CVM_FAU_REG_POOL_3_USE_COUNT, val); \</span>
00253 <span class="preprocessor">            break; \</span>
00254 <span class="preprocessor">        case 4:  \</span>
00255 <span class="preprocessor">            cvmx_fau_atomic_add32(CVM_FAU_REG_POOL_4_USE_COUNT, val); \</span>
00256 <span class="preprocessor">            break; \</span>
00257 <span class="preprocessor">        case 5:  \</span>
00258 <span class="preprocessor">            cvmx_fau_atomic_add32(CVM_FAU_REG_POOL_5_USE_COUNT, val); \</span>
00259 <span class="preprocessor">            break; \</span>
00260 <span class="preprocessor">        case 6:  \</span>
00261 <span class="preprocessor">            cvmx_fau_atomic_add32(CVM_FAU_REG_POOL_6_USE_COUNT, val); \</span>
00262 <span class="preprocessor">            break; \</span>
00263 <span class="preprocessor">        case 7:  \</span>
00264 <span class="preprocessor">            cvmx_fau_atomic_add32(CVM_FAU_REG_POOL_7_USE_COUNT, val); \</span>
00265 <span class="preprocessor">            break; \</span>
00266 <span class="preprocessor">    } \</span>
00267 <span class="preprocessor">}</span>
00268 <span class="preprocessor"></span>
00269 
00270 <span class="comment"></span>
00271 <span class="comment">/** Checks whether the address belongs to correct FPA pool or not</span>
00272 <span class="comment"> *</span>
00273 <span class="comment"> *  @param pool     - FPA pool number</span>
00274 <span class="comment"> *  @param ptr      - address to verify</span>
00275 <span class="comment"> *</span>
00276 <span class="comment"> * This macro checks that the address 'ptr' belongs</span>
00277 <span class="comment"> * to the 'pool' or not.</span>
00278 <span class="comment"> *</span>
00279 <span class="comment"> */</span>
<a name="l00280"></a><a class="code" href="cvm-common-fpa_8h.html#a5">00280</a> <span class="preprocessor">#define CVM_COMMON_CHECK_FPA_POOL(pool, ptr) \</span>
00281 <span class="preprocessor">({ \</span>
00282 <span class="preprocessor">    char correct_pool = 0; \</span>
00283 <span class="preprocessor">    cvm_common_fpa_info_t pool_info = cvm_common_fpa_info[pool]; \</span>
00284 <span class="preprocessor">    int i=0; \</span>
00285 <span class="preprocessor">    for (i=0; i&lt;pool_info.count; i++) \</span>
00286 <span class="preprocessor">    { \</span>
00287 <span class="preprocessor">      if (( (uint64_t)(CAST64(cvmx_phys_to_ptr(CAST64(ptr)))) &gt;= pool_info.entry[i].start_addr) &amp;&amp; ( (uint64_t)(CAST64(cvmx_phys_to_ptr(CAST64(ptr)))) &lt;= pool_info.entry[i].end_addr)) \</span>
00288 <span class="preprocessor">        { \</span>
00289 <span class="preprocessor">            correct_pool = 1; \</span>
00290 <span class="preprocessor">            break; \</span>
00291 <span class="preprocessor">        } \</span>
00292 <span class="preprocessor">    } \</span>
00293 <span class="preprocessor">    correct_pool; \</span>
00294 <span class="preprocessor">})</span>
00295 <span class="preprocessor"></span>
00296 <span class="comment"></span>
00297 <span class="comment">/** Macro to return FPA pool number for a memory address</span>
00298 <span class="comment"> *</span>
00299 <span class="comment"> *  @param ptr      - address pointer</span>
00300 <span class="comment"> *</span>
00301 <span class="comment"> * This macro goes through the stored information to</span>
00302 <span class="comment"> * find out which pool the pointer 'ptr' belongs to</span>
00303 <span class="comment"> *</span>
00304 <span class="comment"> */</span>
<a name="l00305"></a><a class="code" href="cvm-common-fpa_8h.html#a6">00305</a> <span class="preprocessor">#define CVM_COMMON_WHICH_FPA_POOL(ptr) \</span>
00306 <span class="preprocessor">({ \</span>
00307 <span class="preprocessor">    int pool = -1; \</span>
00308 <span class="preprocessor">    int i = 0; \</span>
00309 <span class="preprocessor">    for (i=0; i&lt;CVMX_FPA_NUM_POOLS; i++) \</span>
00310 <span class="preprocessor">    { \</span>
00311 <span class="preprocessor">        cvm_common_fpa_info_t pool_info = cvm_common_fpa_info[i]; \</span>
00312 <span class="preprocessor">        int j=0; \</span>
00313 <span class="preprocessor">        for (j=0; j&lt;pool_info.count; j++) \</span>
00314 <span class="preprocessor">        { \</span>
00315 <span class="preprocessor">      if (( (uint64_t)(CAST64(cvmx_phys_to_ptr(CAST64(ptr)))) &gt;= pool_info.entry[j].start_addr) &amp;&amp; ((uint64_t)(CAST64(cvmx_phys_to_ptr(CAST64(ptr)))) &lt;= pool_info.entry[j].end_addr)) \</span>
00316 <span class="preprocessor">            { \</span>
00317 <span class="preprocessor">                pool = i; \</span>
00318 <span class="preprocessor">                break; \</span>
00319 <span class="preprocessor">            } \</span>
00320 <span class="preprocessor">        } \</span>
00321 <span class="preprocessor">        if (pool != -1) break; \</span>
00322 <span class="preprocessor">    } \</span>
00323 <span class="preprocessor">    pool;\</span>
00324 <span class="preprocessor">})</span>
00325 <span class="preprocessor"></span>
<a name="l00326"></a><a class="code" href="cvm-common-fpa_8h.html#a7">00326</a> <span class="preprocessor">#define CVM_COMMON_WHICH_FPA_POOL_SEGMENT(ptr, pool) \</span>
00327 <span class="preprocessor">({ \</span>
00328 <span class="preprocessor">    int segment = -1; \</span>
00329 <span class="preprocessor">    cvm_common_fpa_info_t pool_info = cvm_common_fpa_info[pool]; \</span>
00330 <span class="preprocessor">    int j = 0; \</span>
00331 <span class="preprocessor">    for (j=0; j&lt;pool_info.count; j++) \</span>
00332 <span class="preprocessor">    { \</span>
00333 <span class="preprocessor">      if (((uint64_t)(CAST64(cvmx_phys_to_ptr(CAST64(ptr)))) &gt;= pool_info.entry[j].start_addr) &amp;&amp; ((uint64_t)(CAST64(cvmx_phys_to_ptr(CAST64(ptr)))) &lt;= pool_info.entry[j].end_addr)) \</span>
00334 <span class="preprocessor">        { \</span>
00335 <span class="preprocessor">            segment = j; \</span>
00336 <span class="preprocessor">            break; \</span>
00337 <span class="preprocessor">        } \</span>
00338 <span class="preprocessor">    } \</span>
00339 <span class="preprocessor">    segment;\</span>
00340 <span class="preprocessor">})</span>
00341 <span class="preprocessor"></span>
00342 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__*/</span>
00343 
00344 
<a name="l00345"></a><a class="code" href="cvm-common-fpa_8h.html#a8">00345</a> <span class="preprocessor">#define CVM_COMMON_MARK_FPA_BUFFER_ALLOC(ptr, pool, label);</span>
<a name="l00346"></a><a class="code" href="cvm-common-fpa_8h.html#a9">00346</a> <span class="preprocessor"></span><span class="preprocessor">#define CVM_COMMON_MARK_FPA_BUFFER_FREE(ptr, pool, label);</span>
00347 <span class="preprocessor"></span>
<a name="l00348"></a><a class="code" href="cvm-common-fpa_8h.html#a28">00348</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-fpa_8h.html#a28">cvm_common_mark_fpa_buffer_alloc</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, uint64_t ptr, uint32_t pool, <span class="keywordtype">int</span> label)
00349 {
00350     <span class="keywordflow">return</span> (0);
00351 }
00352 
<a name="l00353"></a><a class="code" href="cvm-common-fpa_8h.html#a29">00353</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-fpa_8h.html#a29">cvm_common_mark_fpa_buffer_free</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, uint64_t ptr, uint32_t pool, <span class="keywordtype">int</span> label)
00354 {
00355     <span class="keywordflow">return</span> (0);
00356 }
00357 
<a name="l00358"></a><a class="code" href="cvm-common-fpa_8h.html#a10">00358</a> <span class="preprocessor">#define CVM_COMMON_CHECK_BUFFER_BOUNDRIES(ptr, pool, back, calculate_ptr_using_back) \</span>
00359 <span class="preprocessor">({ \</span>
00360 <span class="preprocessor">  int ret = 0; \</span>
00361 <span class="preprocessor">  ret; \</span>
00362 <span class="preprocessor">})</span>
00363 <span class="preprocessor"></span>
<a name="l00364"></a><a class="code" href="cvm-common-fpa_8h.html#a30">00364</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-fpa_8h.html#a30">cvm_common_check_buffer_boundries</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, uint64_t ptr, <span class="keywordtype">int</span> pool, <span class="keywordtype">int</span> back, <span class="keywordtype">int</span> calculate_ptr_using_back)
00365 {
00366     <span class="keywordflow">return</span> (0);
00367 }
00368 
<a name="l00369"></a><a class="code" href="cvm-common-fpa_8h.html#a11">00369</a> <span class="preprocessor">#define CVM_COMMON_INIT_FPA_CHECKS(pool_mem_base, pool_count, single_buffer_size) \</span>
00370 <span class="preprocessor">({ \</span>
00371 <span class="preprocessor">    void* base = NULL; \</span>
00372 <span class="preprocessor">    base; \</span>
00373 <span class="preprocessor">})</span>
00374 <span class="preprocessor"></span>
<a name="l00375"></a><a class="code" href="cvm-common-fpa_8h.html#a12">00375</a> <span class="preprocessor">#define IS_PTR_WITHIN_BUFFER(ptr_in_buffer, ptr_to_test) \</span>
00376 <span class="preprocessor">({ \</span>
00377 <span class="preprocessor">  int ret = 0; \</span>
00378 <span class="preprocessor">  ret; \</span>
00379 <span class="preprocessor">})</span>
00380 <span class="preprocessor"></span>
00381 
00382 
<a name="l00383"></a><a class="code" href="cvm-common-fpa_8h.html#a31">00383</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="cvm-common-fpa_8h.html#a31">cvm_common_is_fpa_buffer_available</a>(uint64_t scratch_ptr)
00384 {
00385 <span class="preprocessor">#if defined(__KERNEL__) &amp;&amp; defined (linux)</span>
00386 <span class="preprocessor"></span>    <span class="comment">/* FIXME: */</span>
00387     <span class="keywordflow">return</span> 1;
00388 <span class="preprocessor">#else</span>
00389 <span class="preprocessor"></span>    uint64_t  so = 0; 
00390     so = cvmx_scratch_read64(scratch_ptr);
00391     <span class="keywordflow">if</span> (so == <a class="code" href="cvm-common-defs_8h.html#a20">CVM_COMMON_ALLOC_INIT</a>)
00392     {
00393         CVMX_SYNCIOBDMA;
00394         so = cvmx_scratch_read64(scratch_ptr);
00395     }
00396 
00397     <span class="keywordflow">if</span> (so == 0x0)
00398     {
00399         <span class="keywordflow">return</span> (0);
00400     }
00401     <span class="keywordflow">return</span> (1);
00402 <span class="preprocessor">#endif</span>
00403 <span class="preprocessor"></span>}
00404 
00405 
<a name="l00406"></a><a class="code" href="cvm-common-fpa_8h.html#a13">00406</a> <span class="preprocessor">#define CVM_COMMON_INC_OOB_COUNT(pool) \</span>
00407 <span class="preprocessor">{ \</span>
00408 <span class="preprocessor">    int offset = pool*4 + CVM_FAU_REG_FPA_OOB_COUNT; \</span>
00409 <span class="preprocessor">    cvmx_fau_atomic_add32( offset, 1); \</span>
00410 <span class="preprocessor">}</span>
00411 <span class="preprocessor"></span>
00412 <span class="comment"></span>
00413 <span class="comment">/** Macro to allocate an FPA buffer</span>
00414 <span class="comment"> *</span>
00415 <span class="comment"> *  @param pool     - FPA pool from which the buffer should be allocated</span>
00416 <span class="comment"> *</span>
00417 <span class="comment"> * This macro is a wraper around the cvmx_fpa_alloc()</span>
00418 <span class="comment"> * executive function.</span>
00419 <span class="comment"> *</span>
00420 <span class="comment"> */</span>
00421 
00422 
<a name="l00423"></a><a class="code" href="cvm-common-fpa_8h.html#a14">00423</a> <span class="preprocessor">#define cvm_common_alloc_fpa_buffer_sync(pool) _alloc_fpa_buffer_sync(__FILE__, __LINE__, pool)</span>
00424 <span class="preprocessor"></span>
<a name="l00425"></a><a class="code" href="cvm-common-fpa_8h.html#a32">00425</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>* <a class="code" href="cvm-common-fpa_8h.html#a32">_alloc_fpa_buffer_sync</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, uint64_t pool)
00426 {
00427     <span class="keywordtype">void</span> *so = NULL;
00428 <span class="preprocessor">#if defined(__KERNEL__)</span>
00429 <span class="preprocessor"></span>    so = (<span class="keywordtype">void</span> *)cvmx_fpa_alloc(pool);
00430     <span class="keywordflow">if</span> (so == NULL)
00431     {
00432     <a class="code" href="cvm-common-fpa_8h.html#a13">CVM_COMMON_INC_OOB_COUNT</a>(pool);
00433     <span class="keywordflow">return</span> NULL;
00434     }
00435     <span class="keywordflow">return</span> so;
00436 
00437 <span class="preprocessor">#else</span>
00438 <span class="preprocessor"></span>
00439     <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a2">CVM_COMMON_TRACE_ENTER</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a14">cvm_common_alloc_fpa_buffer_sync</a>, pool);
00440   
00441     so = (<span class="keywordtype">void</span> *)cvmx_fpa_alloc(pool);
00442     <span class="keywordflow">if</span> (so == 0)
00443     {
00444         <span class="comment">/* out of buffers */</span>
00445         <a class="code" href="cvm-common-fpa_8h.html#a13">CVM_COMMON_INC_OOB_COUNT</a>(pool);
00446         <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a4">CVM_COMMON_TRACE_EXIT</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a14">cvm_common_alloc_fpa_buffer_sync</a>, so);
00447         <span class="keywordflow">return</span> (NULL);
00448     }
00449 
00450     <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a3">CVM_COMMON_TRACE_BODY</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a14">cvm_common_alloc_fpa_buffer_sync</a>, so);
00451 
00452 
00453     <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a4">CVM_COMMON_TRACE_EXIT</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a14">cvm_common_alloc_fpa_buffer_sync</a>, so);
00454     <span class="keywordflow">return</span> (so);
00455 <span class="preprocessor">#endif </span><span class="comment">/*__KERNEL__*/</span>
00456 }
00457 
00458 
00459 <span class="comment"></span>
00460 <span class="comment">/** Macro to allocate an FPA buffer asynchronously</span>
00461 <span class="comment"> *</span>
00462 <span class="comment"> *  @param scratch_ptr - Scratch pad register address</span>
00463 <span class="comment"> *  @param pool        - FPA pool from which the buffer should be allocated</span>
00464 <span class="comment"> *</span>
00465 <span class="comment"> * This macro is a wraper around the cvmx_fpa_alloc()</span>
00466 <span class="comment"> * executive function. It tries to read an already</span>
00467 <span class="comment"> * allocated FPA buffer address from the scratch pad</span>
00468 <span class="comment"> * register. Once that is done, another buffer allocation</span>
00469 <span class="comment"> * request is initiated to work in the background and</span>
00470 <span class="comment"> * results are stored in the same scratch pad register.</span>
00471 <span class="comment"> * This register value is used for the next allocation.</span>
00472 <span class="comment"> *</span>
00473 <span class="comment"> */</span>
00474 
00475 
<a name="l00476"></a><a class="code" href="cvm-common-fpa_8h.html#a15">00476</a> <span class="preprocessor">#define cvm_common_alloc_fpa_buffer(scratch_ptr, pool) _alloc_fpa_buffer(__FILE__, __LINE__, scratch_ptr, pool)</span>
00477 <span class="preprocessor"></span>
<a name="l00478"></a><a class="code" href="cvm-common-fpa_8h.html#a33">00478</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>* <a class="code" href="cvm-common-fpa_8h.html#a33">_alloc_fpa_buffer</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, uint64_t scratch_ptr, uint64_t pool)
00479 {
00480 <span class="preprocessor">#if defined(USE_SYNC_ALLOC) || defined (__KERNEL__)</span>
00481 <span class="preprocessor"></span>  <span class="keywordflow">return</span> ( <a class="code" href="cvm-common-fpa_8h.html#a32">_alloc_fpa_buffer_sync</a>(file, line, pool) );
00482 <span class="preprocessor">#else</span>
00483 <span class="preprocessor"></span>
00484     <span class="keywordtype">void</span> *so_ptr = NULL;
00485     uint64_t  so64 = 0;
00486 
00487     <a class="code" href="cvm-common-misc_8h.html#a13">CVM_COMMON_TRACE_P2</a> (<a class="code" href="cvm-common-misc_8h.html#a2">CVM_COMMON_TRACE_ENTER</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a15">cvm_common_alloc_fpa_buffer</a>, scratch_ptr, pool);
00488 
00489     so64 = cvmx_scratch_read64(scratch_ptr);
00490     <span class="keywordflow">if</span> (so64 == <a class="code" href="cvm-common-defs_8h.html#a20">CVM_COMMON_ALLOC_INIT</a>)
00491     {
00492         CVMX_SYNCIOBDMA;
00493         so64 = cvmx_scratch_read64(scratch_ptr);
00494     }
00495 
00496     <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a3">CVM_COMMON_TRACE_BODY</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a15">cvm_common_alloc_fpa_buffer</a>, so64);
00497 
00498     <span class="keywordflow">if</span> (so64 == 0)
00499     {
00500         <span class="comment">/* out of buffers */</span>
00501         <a class="code" href="cvm-common-fpa_8h.html#a13">CVM_COMMON_INC_OOB_COUNT</a>(pool);
00502         <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a4">CVM_COMMON_TRACE_EXIT</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a15">cvm_common_alloc_fpa_buffer</a>, so64);
00503     }
00504     <span class="keywordflow">else</span>
00505     {
00506         so_ptr = cvmx_phys_to_ptr(so64);
00507     }
00508 
00509     <span class="comment">/* set scratch reg to CVM_COMMON_ALLOC_INIT so that we can verify a new ptr is written */</span>
00510     cvmx_scratch_write64(scratch_ptr, <a class="code" href="cvm-common-defs_8h.html#a20">CVM_COMMON_ALLOC_INIT</a>);
00511     CVMX_SYNCWS;
00512     cvmx_fpa_async_alloc(scratch_ptr, pool);
00513 
00514     <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a4">CVM_COMMON_TRACE_EXIT</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a15">cvm_common_alloc_fpa_buffer</a>, so64);
00515     <span class="keywordflow">return</span> (so_ptr);
00516 <span class="preprocessor">#endif </span><span class="comment">/* USE_SYNC_ALLOC */</span>
00517 }
00518 
00519 
00520 <span class="comment"></span>
00521 <span class="comment">/** Macro to free an allocated FPA buffer</span>
00522 <span class="comment"> *</span>
00523 <span class="comment"> *  @param ptr       - FPA address to be freed</span>
00524 <span class="comment"> *  @param pool      - FPA pool to which the buffer should be freed</span>
00525 <span class="comment"> *  @num_cache_lines - number of cache lines to be invalidated</span>
00526 <span class="comment"> *</span>
00527 <span class="comment"> * This macro is a wraper around the cvmx_fpa_free()</span>
00528 <span class="comment"> * executive function. </span>
00529 <span class="comment"> */</span>
00530 
00531 
<a name="l00532"></a><a class="code" href="cvm-common-fpa_8h.html#a16">00532</a> <span class="preprocessor">#define cvm_common_free_fpa_buffer(ptr, pool, num_cache_lines) _free_fpa_buffer(__FILE__, __LINE__, ptr, pool, num_cache_lines)</span>
00533 <span class="preprocessor"></span>
<a name="l00534"></a><a class="code" href="cvm-common-fpa_8h.html#a34">00534</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-fpa_8h.html#a34">_free_fpa_buffer</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, <span class="keywordtype">void</span> *ptr, uint64_t pool, uint64_t num_cache_lines)
00535 {
00536 <span class="preprocessor">#if defined(__KERNEL__)</span>
00537 <span class="preprocessor"></span>  cvmx_buf_ptr_t buffer = (cvmx_buf_ptr_t) ptr;
00538 
00539   CVMX_SYNCW;
00540 
00541   <span class="comment">/* use bit 35 to mark struct page buffer */</span>
00542   <span class="keywordflow">if</span> (buffer.s.addr &amp; 0x800000000)
00543   {
00544       <span class="comment">/* free the page here; make sure to move back address to page boundry */</span>
00545       <span class="keyword">struct </span>page *page = NULL;
00546       uint64_t ptr_u64 = (uint64_t) ptr &amp; (~0x800000000ULL);
00547 
00548       ptr_u64 &amp;= PAGE_MASK;
00549       ptr_u64 = cvmx_ptr_to_phys(CASTPTR(<span class="keywordtype">void</span>, ptr_u64));
00550       page = pfn_to_page(ptr_u64 &gt;&gt; PAGE_SHIFT);
00551       put_page(page);
00552   }
00553   <span class="keywordflow">else</span>
00554   {
00555       cvmx_fpa_free(ptr, pool, 0);
00556   }
00557 <span class="preprocessor">#else</span>
00558 <span class="preprocessor"></span>
00559   <a class="code" href="cvm-common-misc_8h.html#a14">CVM_COMMON_TRACE_P3</a> (<a class="code" href="cvm-common-misc_8h.html#a2">CVM_COMMON_TRACE_ENTER</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a16">cvm_common_free_fpa_buffer</a>, ptr, pool, num_cache_lines);
00560 
00561 
00562     CVMX_SYNCWS;
00563 
00564     <span class="keywordflow">if</span> (pool == CVMX_FPA_WQE_POOL)
00565     {
00566        cvmx_fpa_free(ptr, pool, CVMX_FPA_WQE_POOL_SIZE / CVMX_CACHE_LINE_SIZE);
00567     }
00568     <span class="keywordflow">else</span>
00569     {
00570        cvmx_fpa_free(ptr, pool, 0);
00571        num_cache_lines = 0; <span class="comment">/* keep the compiler happy */</span>
00572     }
00573 
00574     <a class="code" href="cvm-common-misc_8h.html#a13">CVM_COMMON_TRACE_P2</a> (<a class="code" href="cvm-common-misc_8h.html#a4">CVM_COMMON_TRACE_EXIT</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a16">cvm_common_free_fpa_buffer</a>, ptr, pool);
00575 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL __*/</span>
00576 }
00577 
00578 
00579 
00580 <span class="comment"></span>
00581 <span class="comment">/** Macro to free an allocated FPA buffer after adjusting the</span>
00582 <span class="comment"> *  start address correctly using the back field</span>
00583 <span class="comment"> *</span>
00584 <span class="comment"> *  @param ptr       - FPA address to be freed (cvmx_buf_ptr_t format)</span>
00585 <span class="comment"> *</span>
00586 <span class="comment"> * This macro calculates the start address of the</span>
00587 <span class="comment"> * buffer correctly using the 'back' field before</span>
00588 <span class="comment"> * freeing the buffer. The pool information is also</span>
00589 <span class="comment"> * extracted from the 'ptr' parameter.</span>
00590 <span class="comment"> *</span>
00591 <span class="comment"> */</span>
<a name="l00592"></a><a class="code" href="cvm-common-fpa_8h.html#a17">00592</a> <span class="preprocessor">#define cvm_common_mbuf_free(ptr) _mbuf_free(__FILE__, __LINE__, ptr)</span>
00593 <span class="preprocessor"></span>
<a name="l00594"></a><a class="code" href="cvm-common-fpa_8h.html#a35">00594</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-fpa_8h.html#a35">_mbuf_free</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, cvmx_buf_ptr_t ptr)
00595 {
00596    uint64_t num_cache_lines = 0;
00597 
00598    <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a2">CVM_COMMON_TRACE_ENTER</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a17">cvm_common_mbuf_free</a>, ptr.u64);
00599 
00600    <span class="keywordflow">if</span> ((ptr.s.pool == CVMX_FPA_WQE_POOL) &amp;&amp; (ptr.s.back == <a class="code" href="cvm-common-defs_8h.html#a37">CVM_COMMON_MALLOC_BACK_VAL</a>))
00601    {
00602        <a class="code" href="cvm-common-defs_8h.html#a43">CVM_COMMON_FREE_TSAFE</a>((<span class="keywordtype">void</span> *)(cvmx_phys_to_ptr(ptr.s.addr)) );
00603    }
00604    <span class="keywordflow">else</span>
00605    {
00606       <span class="keywordflow">switch</span> (ptr.s.pool)
00607       {
00608      <span class="keywordflow">case</span> 0:
00609         num_cache_lines = CVMX_FPA_POOL_0_SIZE / CVMX_CACHE_LINE_SIZE;
00610         <span class="keywordflow">break</span>;
00611      <span class="keywordflow">case</span> 1:
00612         num_cache_lines = CVMX_FPA_POOL_1_SIZE / CVMX_CACHE_LINE_SIZE;
00613         <span class="keywordflow">break</span>;
00614      <span class="keywordflow">case</span> 2:
00615         num_cache_lines = CVMX_FPA_POOL_2_SIZE / CVMX_CACHE_LINE_SIZE;
00616         <span class="keywordflow">break</span>;
00617      <span class="keywordflow">case</span> 3:
00618         num_cache_lines = CVMX_FPA_POOL_3_SIZE / CVMX_CACHE_LINE_SIZE;
00619         <span class="keywordflow">break</span>;
00620      <span class="keywordflow">case</span> 4:
00621         num_cache_lines = CVMX_FPA_POOL_4_SIZE / CVMX_CACHE_LINE_SIZE;
00622         <span class="keywordflow">break</span>;
00623      <span class="keywordflow">case</span> 5:
00624         num_cache_lines = CVMX_FPA_POOL_5_SIZE / CVMX_CACHE_LINE_SIZE;
00625         <span class="keywordflow">break</span>;
00626      <span class="keywordflow">case</span> 6:
00627         num_cache_lines = CVMX_FPA_POOL_6_SIZE / CVMX_CACHE_LINE_SIZE;
00628         <span class="keywordflow">break</span>;
00629      <span class="keywordflow">case</span> 7:
00630         num_cache_lines = CVMX_FPA_POOL_7_SIZE / CVMX_CACHE_LINE_SIZE;
00631         <span class="keywordflow">break</span>;
00632       }
00633 
00634       <a class="code" href="cvm-common-fpa_8h.html#a34">_free_fpa_buffer</a>(file, line,  (<span class="keywordtype">void</span> *)(cvmx_phys_to_ptr((ptr.s.addr &amp; ~127) - 128*ptr.s.back)), ptr.s.pool, num_cache_lines);
00635 
00636    }
00637 
00638    <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a4">CVM_COMMON_TRACE_EXIT</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a17">cvm_common_mbuf_free</a>, ptr.u64);
00639    <span class="keywordflow">return</span>;
00640 }
00641 
00642 <span class="comment"></span>
00643 <span class="comment">/** Macro to free linked/gather buffer pointed to</span>
00644 <span class="comment"> *  by the packet_ptr field of work queue entry</span>
00645 <span class="comment"> *</span>
00646 <span class="comment"> *  @param swp       - pointer to work queue entry</span>
00647 <span class="comment"> *</span>
00648 <span class="comment"> * This macro frees linked or gather list pointed </span>
00649 <span class="comment"> * to by the packet_ptr field of work queue entry.</span>
00650 <span class="comment"> *</span>
00651 <span class="comment"> */</span>
<a name="l00652"></a><a class="code" href="cvm-common-fpa_8h.html#a18">00652</a> <span class="preprocessor">#define cvm_common_packet_free(swp) _packet_free(__FILE__, __LINE__, swp)</span>
00653 <span class="preprocessor"></span>
<a name="l00654"></a><a class="code" href="cvm-common-fpa_8h.html#a36">00654</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-fpa_8h.html#a36">_packet_free</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, <a class="code" href="structcvm__common__wqe.html">cvm_common_wqe_t</a> *swp)
00655 {
00656    <span class="keywordtype">int</span> i;
00657  
00658    <a class="code" href="cvm-common-misc_8h.html#a13">CVM_COMMON_TRACE_P2</a> (<a class="code" href="cvm-common-misc_8h.html#a2">CVM_COMMON_TRACE_ENTER</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a18">cvm_common_packet_free</a>, swp, swp-&gt;<a class="code" href="structcvm__common__wqe.html#o14">control</a>.gth);
00659 
00660    <span class="keywordflow">if</span> (swp-&gt;<a class="code" href="structcvm__common__wqe.html#o14">control</a>.gth == 0)
00661    {
00662        cvmx_buf_ptr_t next_ptr;
00663        cvmx_buf_ptr_t ptr = swp-&gt;<a class="code" href="structcvm__common__wqe.html#o0">hw_wqe</a>.packet_ptr;
00664        uint8_t *ptr_virt =  cvmx_phys_to_ptr(ptr.s.addr);
00665        <span class="keywordtype">int</span> buf_cnt = swp-&gt;<a class="code" href="structcvm__common__wqe.html#o0">hw_wqe</a>.word2.s.bufs;
00666 
00667        <a class="code" href="cvm-common-misc_8h.html#a13">CVM_COMMON_TRACE_P2</a> (<a class="code" href="cvm-common-misc_8h.html#a3">CVM_COMMON_TRACE_BODY</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a18">cvm_common_packet_free</a>, ptr.u64, buf_cnt);
00668 
00669        <span class="keywordflow">if</span> (buf_cnt &gt; 0) 
00670        {
00671        <span class="keywordflow">for</span> (i=0; i&lt;(buf_cnt - 1); i++)
00672        {
00673            next_ptr = *((cvmx_buf_ptr_t *)(ptr_virt - 8));
00674 
00675            <a class="code" href="cvm-common-fpa_8h.html#a35">_mbuf_free</a>(file, line, ptr);
00676            ptr = next_ptr;
00677                ptr_virt =  cvmx_phys_to_ptr(ptr.s.addr);
00678        }
00679        <a class="code" href="cvm-common-fpa_8h.html#a35">_mbuf_free</a>(file, line, ptr);
00680        }
00681    }
00682    <span class="keywordflow">else</span>
00683    {
00684         cvmx_buf_ptr_t  *gather_list_addr = (cvmx_buf_ptr_t *)cvmx_phys_to_ptr(swp-&gt;<a class="code" href="structcvm__common__wqe.html#o0">hw_wqe</a>.packet_ptr.s.addr);
00685 
00686         <a class="code" href="cvm-common-misc_8h.html#a13">CVM_COMMON_TRACE_P2</a> (<a class="code" href="cvm-common-misc_8h.html#a3">CVM_COMMON_TRACE_BODY</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a18">cvm_common_packet_free</a>, CAST64(gather_list_addr), swp-&gt;<a class="code" href="structcvm__common__wqe.html#o0">hw_wqe</a>.word2.s.bufs);
00687 
00688         <span class="keywordflow">for</span> (i=0; i&lt;swp-&gt;hw_wqe.word2.s.bufs; i++)
00689     {
00690         <span class="keywordflow">if</span> (gather_list_addr[i].s.i == 1)
00691         {
00692             <a class="code" href="cvm-common-fpa_8h.html#a35">_mbuf_free</a>(file, line, gather_list_addr[i]);
00693         }
00694     }
00695     <a class="code" href="cvm-common-fpa_8h.html#a35">_mbuf_free</a>(file, line, swp-&gt;<a class="code" href="structcvm__common__wqe.html#o0">hw_wqe</a>.packet_ptr);
00696    }
00697 
00698    <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a4">CVM_COMMON_TRACE_EXIT</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a18">cvm_common_packet_free</a>, swp);
00699 }
00700 
00701 <span class="comment"></span>
00702 <span class="comment">/** Macro to free both the linked/gather buffer pointed </span>
00703 <span class="comment"> *  to by the packet_ptr field of work queue entry as</span>
00704 <span class="comment"> *  well as the work queue entry itself</span>
00705 <span class="comment"> *</span>
00706 <span class="comment"> *  @param swp       - pointer to work queue entry</span>
00707 <span class="comment"> *</span>
00708 <span class="comment"> * This macro frees linked or gather list pointed </span>
00709 <span class="comment"> * to by the packet_ptr field of work queue entry</span>
00710 <span class="comment"> * as well as the work qneue entry</span>
00711 <span class="comment"> *</span>
00712 <span class="comment"> */</span>
<a name="l00713"></a><a class="code" href="cvm-common-fpa_8h.html#a19">00713</a> <span class="preprocessor">#define cvm_common_discard_swp(swp) _discard_swp(__FILE__, __LINE__, swp)</span>
00714 <span class="preprocessor"></span>
<a name="l00715"></a><a class="code" href="cvm-common-fpa_8h.html#a37">00715</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="cvm-common-fpa_8h.html#a37">_discard_swp</a>(<span class="keywordtype">char</span>* file, <span class="keywordtype">int</span> line, <a class="code" href="structcvm__common__wqe.html">cvm_common_wqe_t</a> *swp)
00716 {
00717    <a class="code" href="structcvm__common__wqe.html">cvm_common_wqe_t</a> *tmp_swp;
00718 
00719    <a class="code" href="cvm-common-defs_8h.html#a40">CVM_COMMON_DBG_MSG</a>(<a class="code" href="cvm-common-defs_8h.html#a119a100">CVM_COMMON_DBG_LVL_7</a>, <span class="stringliteral">"discard_swp: %p\n"</span>, swp);
00720    <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a2">CVM_COMMON_TRACE_ENTER</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a19">cvm_common_discard_swp</a>, swp);
00721 
00722    <span class="keywordflow">while</span> (swp) 
00723    {
00724        <a class="code" href="cvm-common-fpa_8h.html#a36">_packet_free</a>(file, line, swp);
00725       tmp_swp = swp;
00726       swp = swp-&gt;<a class="code" href="structcvm__common__wqe.html#o1">next</a>;
00727       <a class="code" href="cvm-common-fpa_8h.html#a34">_free_fpa_buffer</a>(file, line, tmp_swp, CVMX_FPA_WQE_POOL, CVMX_FPA_WQE_POOL_SIZE / CVMX_CACHE_LINE_SIZE);
00728    }
00729    <a class="code" href="cvm-common-misc_8h.html#a12">CVM_COMMON_TRACE_P1</a> (<a class="code" href="cvm-common-misc_8h.html#a4">CVM_COMMON_TRACE_EXIT</a>, <a class="code" href="cvm-common-misc_8h.html#a5">CVM_COMMON_TRACE_FNPTR</a>, <a class="code" href="cvm-common-fpa_8h.html#a19">cvm_common_discard_swp</a>, swp);
00730 }
00731 
00732 
00733 <span class="comment">/*</span>
00734 <span class="comment"> * Function prototypes</span>
00735 <span class="comment"> */</span>
00736 <span class="keywordtype">void</span>* <a class="code" href="cvm-common-fpa_8h.html#a38">cvm_common_setup_fpa_pool</a>(<span class="keywordtype">int</span> pool, <span class="keywordtype">int</span> entry_size, <span class="keywordtype">int</span> buf_count, <span class="keywordtype">char</span>* pool_name);
00737 
00738 
00739 <span class="preprocessor">#endif </span><span class="comment">/* _CVM_COMMON_FPA_H__ */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Oct 25 14:15:48 2011 for Octeon Common Component by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
