<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Octeon PCI Driver: cvm-pci-dma.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>cvm-pci-dma.h</h1><a href="cvm-pci-dma_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*! \file cvm-pci-dma.h</span>
<a name="l00002"></a>00002 <span class="comment">    \brief  Core Driver: Structures and routines for PCI DMA queue</span>
<a name="l00003"></a>00003 <span class="comment">            management.</span>
<a name="l00004"></a>00004 <span class="comment"> */</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#ifndef __CVM_PCI_DMA_H__</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor">#define __CVM_PCI_DMA_H__</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span>
<a name="l00009"></a>00009 <span class="preprocessor">#include  "<a class="code" href="cvm-driver-defs_8h.html">cvm-driver-defs.h</a>"</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include  "<a class="code" href="cvm-oct-dev_8h.html">cvm-oct-dev.h</a>"</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="comment">/* Enable this flag to turn on tracking of PCI DMA transactions.</span>
<a name="l00014"></a>00014 <span class="comment">   See cvm-pci-dma.c for a description of the tracking mechanism.</span>
<a name="l00015"></a>00015 <span class="comment">*/</span>
<a name="l00016"></a>00016 <span class="comment">//#define CVM_PCI_TRACK_DMA</span>
<a name="l00017"></a>00017 <span class="preprocessor">#define CVM_PCI_DMA_TRACKER_PORT   0x2f</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span><span class="preprocessor">#define CVM_PCI_DMA_TRACKER_TAG    0x12345678</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#define MAX_PCI_DMA_LOCAL_BUF_SIZE    ((1 &lt;&lt; 13) - 8)</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#define CVM_FPA_DMA_CHUNK_POOL        CVMX_FPA_PACKET_POOL</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#define CVM_SCR_DMA_CHUNK_ALLOC       CVM_DRV_SCR_PACKET_BUF_PTR</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#define CVM_DMA_CHUNK_SIZE    \</span>
<a name="l00027"></a>00027 <span class="preprocessor">       (cvmx_fpa_get_block_size(CVM_FPA_DMA_CHUNK_POOL))</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#define OCTEON_MAX_DMA_LOCAL_POINTERS          14</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#define OCTEON_MAX_DMA_REMOTE_POINTERS         13</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span><span class="preprocessor">#define OCTEON_MAX_DMA_POINTERS                27</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a><a class="code" href="cvm-pci-dma_8h.html#dc37acbe563e2f012337dc5c8f1dc0a0">00034</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
<a name="l00035"></a>00035 
<a name="l00036"></a>00036     <a class="code" href="cvm-pci-dma_8h.html#dc37acbe563e2f012337dc5c8f1dc0a0c9f22b0605df0432c34b811e731e9c75">CVMX_DMA_QUEUE0</a> = 0,
<a name="l00037"></a>00037     <a class="code" href="cvm-pci-dma_8h.html#dc37acbe563e2f012337dc5c8f1dc0a07aec5a2698cbd970b98b351fceb427fa">CVMX_DMA_QUEUE1</a> = 1,
<a name="l00038"></a>00038     <a class="code" href="cvm-pci-dma_8h.html#dc37acbe563e2f012337dc5c8f1dc0a033d540ad9a22da075fedbd2db1156cb0">CVMX_DMA_QUEUE2</a> = 2,
<a name="l00039"></a>00039     <a class="code" href="cvm-pci-dma_8h.html#dc37acbe563e2f012337dc5c8f1dc0a027b1f248f87e912bf44794032277f632">CVMX_DMA_QUEUE3</a> = 3,
<a name="l00040"></a>00040     <a class="code" href="cvm-pci-dma_8h.html#dc37acbe563e2f012337dc5c8f1dc0a0e8b7323a74f0d7c62965c8c4ec634529">CVMX_DMA_QUEUE4</a> = 4,
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 }<a class="code" href="cvm-pci-dma_8h.html#dc37acbe563e2f012337dc5c8f1dc0a0">CVMX_DMA_QUEUE_TYPE</a>;
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#define  CVM_PCI_DMA_START_ADDR_REG(q_no)  \</span>
<a name="l00045"></a>00045 <span class="preprocessor">    ((q_no)?CVMX_NPI_LOWP_IBUFF_SADDR:CVMX_NPI_HIGHP_IBUFF_SADDR)</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#define  CVM_PCI_DMA_DOORBELL_REG(q_no)  \</span>
<a name="l00048"></a>00048 <span class="preprocessor">    ((q_no)?CVMX_NPI_LOWP_DBELL:CVMX_NPI_HIGHP_DBELL)</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#define CVMX_HIGHP_DMA_QUEUE    CVMX_DMA_QUEUE0</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#define CVMX_LOWP_DMA_QUEUE     CVMX_DMA_QUEUE1 </span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/* Core: Flags in cvm_pci_dma_cmd_t can take one or more of the </span>
<a name="l00060"></a>00060 <span class="comment">         values defined here. The flags are used in PCI send and receive API's.</span>
<a name="l00061"></a>00061 <span class="comment"></span>
<a name="l00062"></a>00062 <span class="comment">  -------</span>
<a name="l00063"></a>00063 <span class="comment">|  Bit 7  | - Reserved</span>
<a name="l00064"></a>00064 <span class="comment">  -------</span>
<a name="l00065"></a>00065 <span class="comment">|  Bit 6  | - If set, DMA Command uses WQE for completion; </span>
<a name="l00066"></a>00066 <span class="comment">  -------</span>
<a name="l00067"></a>00067 <span class="comment">|  Bit 5  | - If set, DMA Command FreeLocal bit is set.</span>
<a name="l00068"></a>00068 <span class="comment">  -------</span>
<a name="l00069"></a>00069 <span class="comment">|  Bit 4  | - If set, DMA Command IgnoreI bit is set.</span>
<a name="l00070"></a>00070 <span class="comment">  -------</span>
<a name="l00071"></a>00071 <span class="comment">|  Bit 3  | - If set, DMA Command Force Interrupt bit is set</span>
<a name="l00072"></a>00072 <span class="comment">  -------</span>
<a name="l00073"></a>00073 <span class="comment">|  Bit 2  | - If set, DMA Command Counter Add bit is set</span>
<a name="l00074"></a>00074 <span class="comment">  -------</span>
<a name="l00075"></a>00075 <span class="comment">| Bit 0-1 | - Direction.</span>
<a name="l00076"></a>00076 <span class="comment">  ------- </span>
<a name="l00077"></a>00077 <span class="comment">*/</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9e">00080</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
<a name="l00081"></a>00081     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9ee157643cc3926dae736c7000e146b340">PCI_DMA_OUTBOUND</a>  =  0,     <span class="comment">/* Default DMA direction is outbound */</span>
<a name="l00082"></a>00082     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9e08a9f3781491acd9575a967cb9989f2e">PCI_DMA_INBOUND</a>   =  1,
<a name="l00083"></a>00083     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9e93a658390371e94b9c075dc20f2e0cfb">PCI_DMA_EXTERNAL</a>  =  2,
<a name="l00084"></a>00084     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9ed86f1561672f4fe1959e7209fe5d291d">PCI_DMA_INTERNAL</a>  =  3,
<a name="l00085"></a>00085     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9edc8273cf6e2e3adf7e0673775aaaa28d">PCI_DMA_CNTRADD</a>   =  4,
<a name="l00086"></a>00086     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9e98b428007ff810070cb29932e9011470">PCI_DMA_FORCEINT</a>  =  8,
<a name="l00087"></a>00087     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9e44abc7b28e2d13223e4b9e7961911fbb">PCI_DMA_IGNOREI</a>   =  16,
<a name="l00088"></a>00088     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9ec73c033387be34671516d52f94459012">PCI_DMA_FREELOCAL</a> =  32, 
<a name="l00089"></a>00089     <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9e2b1bdde43c6db39a837f858710893e3d">PCI_DMA_PUTWQE</a>    =  64,
<a name="l00090"></a>00090 } <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9e">oct_pci_dma_flags_t</a>;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">/* There is no bit set in the DMA command for using a memory location for</span>
<a name="l00094"></a>00094 <span class="comment">   completion. This flag is defined here just to complete the set of flags.</span>
<a name="l00095"></a>00095 <span class="comment">*/</span>
<a name="l00096"></a>00096 <span class="preprocessor">#define PCI_DMA_PUTWORD    0</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="comment">/* By default, none of the above flags are set. The driver would still set the</span>
<a name="l00100"></a>00100 <span class="comment">   force interrupt bit for a instruction response.</span>
<a name="l00101"></a>00101 <span class="comment">*/</span>
<a name="l00102"></a>00102 <span class="preprocessor">#define PCI_DMA_FLAGS_DEFAULT  0</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="comment">/* Normal local buffer pointer and DMA local buffer pointer differ in the</span>
<a name="l00107"></a>00107 <span class="comment"> * bits below. </span>
<a name="l00108"></a>00108 <span class="comment"> * Bit53 should not be set, Bits 39-36 should not be set. */</span>
<a name="l00109"></a>00109 <span class="preprocessor">#define  CVM_PCI_DMA_LOCAL_PTR_MASK   0xFFDFFF0FFFFFFFFFULL</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="cvm-pci-dma_8h.html#7a8280fb2af8dce1b95783d51dfc6ab5">00114</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <a class="code" href="cvm-pci-dma_8h.html#7a8280fb2af8dce1b95783d51dfc6ab55a512a51308265105cf71b3574589dcd">DMA_BLOCKING</a>     = 1,
<a name="l00117"></a>00117     <a class="code" href="cvm-pci-dma_8h.html#7a8280fb2af8dce1b95783d51dfc6ab5eaa393fba625af8d9a0832d70f8c3769">DMA_NON_BLOCKING</a> = 2
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 } <a class="code" href="cvm-pci-dma_8h.html#7a8280fb2af8dce1b95783d51dfc6ab5">DMA_ACTION</a>;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">/** Core: Hardware defined 64-bit PCI DMA command structure. Most of the bits</span>
<a name="l00125"></a>00125 <span class="comment">    are shared across all Octeon processors. Some bits were reserved in</span>
<a name="l00126"></a>00126 <span class="comment">    CN38XX/CN58XX processors but have meaning in CN56XX. */</span>
<a name="l00127"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html">00127</a> <span class="keyword">typedef</span> <span class="keyword">union </span>{
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#9e960a31ba2d63b68947fe226170a2be">00129</a>     uint64_t       u64;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <span class="keyword">struct </span>{
<a name="l00132"></a>00132 <span class="preprocessor">#if __BYTE_ORDER == __LITTLE_ENDIAN</span>
<a name="l00133"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#6b93b7e42cb08fb51911a047c9c02070">00133</a> <span class="preprocessor"></span>        uint64_t   ptr  :40;
<a name="l00134"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#3b8299af499a3c8cff051d38fe4451e1">00134</a>         uint64_t   nl   : 4;
<a name="l00135"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#0f90314c26a73900e25d1fa17d052d6b">00135</a>         uint64_t   nr   : 4;
<a name="l00136"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#1d51d7427d7678ef53505cf05c41f71f">00136</a>         uint64_t   fl   : 1;
<a name="l00137"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#affc74228a68141f56272d1d1c2a77b9">00137</a>         uint64_t   ii   : 1;
<a name="l00138"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#1c002491536565c8198a1e3b69493917">00138</a>         uint64_t   fi   : 1;
<a name="l00139"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#d4a89cc09c9a81a11d80c4c0f7313b83">00139</a>         uint64_t   ca   : 1;
<a name="l00140"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#b2850a9a17117e0e9d85afb3b63f564e">00140</a>         uint64_t   c    : 1;
<a name="l00141"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#119a665527d5c988805b6af954c47198">00141</a>         uint64_t   wqp  : 1;
<a name="l00142"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#28fa6ea664bcf0931f393888d1c77a6d">00142</a>         uint64_t   dir  : 2;  <span class="comment">/**&lt; This field is 1 bit wide in CN38xx/58xx */</span>
<a name="l00143"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#81531d1ae71567997a3e6103999429ac">00143</a>         uint64_t   lport: 2;  <span class="comment">/**&lt; This field doesn't exist in CN38xx/58xx */</span>
<a name="l00144"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#b1adce198f51bd87fc3cd00c21149f38">00144</a>         uint64_t   fport: 2;  <span class="comment">/**&lt; This field doesn't exist in CN38xx/58xx */</span>
<a name="l00145"></a><a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html#4a43ac6e016dcb67f6b3dcbc378d0a8f">00145</a>         uint64_t   <a class="code" href="struct____cvm__pci__pko__qmap.html#ef68a046ffa99ad42372fd05b41777d0">rsvd</a> : 4;  
<a name="l00146"></a>00146 <span class="preprocessor">#else</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>        uint64_t   <a class="code" href="struct____cvm__pci__pko__qmap.html#ef68a046ffa99ad42372fd05b41777d0">rsvd</a> : 4;
<a name="l00148"></a>00148         uint64_t   fport: 2;  <span class="comment">/**&lt; This field doesn't exist in CN38xx/58xx */</span>
<a name="l00149"></a>00149         uint64_t   lport: 2;  <span class="comment">/**&lt; This field doesn't exist in CN38xx/58xx */</span>
<a name="l00150"></a>00150         uint64_t   dir  : 2;  <span class="comment">/**&lt; This field is 1 bit wide in CN38xx/58xx */</span>
<a name="l00151"></a>00151         uint64_t   wqp  : 1;
<a name="l00152"></a>00152         uint64_t   c    : 1;
<a name="l00153"></a>00153         uint64_t   ca   : 1;
<a name="l00154"></a>00154         uint64_t   fi   : 1;
<a name="l00155"></a>00155         uint64_t   ii   : 1;
<a name="l00156"></a>00156         uint64_t   fl   : 1;
<a name="l00157"></a>00157         uint64_t   nr   : 4;
<a name="l00158"></a>00158         uint64_t   nl   : 4;
<a name="l00159"></a>00159         uint64_t   ptr  :40;
<a name="l00160"></a>00160 <span class="preprocessor">#endif</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>    } s;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 } <a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html">cvmx_oct_pci_dma_inst_hdr_t</a>;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="comment"></span>
<a name="l00170"></a>00170 <span class="comment">/** Core: Hardware defined 64-bit PCI DMA local buffer format. */</span>
<a name="l00171"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html">00171</a> <span class="keyword">typedef</span> <span class="keyword">union </span>{
<a name="l00172"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#2d4cfbd8dc65bedda536662aabf97c59">00172</a>    uint64_t                   u64;
<a name="l00173"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#5a298cb5daa861253e5ccf2b0c3cf494">00173</a>    <span class="keywordtype">void</span>                    *ptr;
<a name="l00174"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#0d76e22c2157b06a51595f2244f2eabf">00174</a>    uint64_t               *u64ptr;
<a name="l00175"></a>00175    <span class="keyword">struct </span>{
<a name="l00176"></a>00176 <span class="preprocessor">#if __BYTE_ORDER == __LITTLE_ENDIAN</span>
<a name="l00177"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#a49ed75bce947a6e679309c4260cff96">00177</a> <span class="preprocessor"></span>      uint64_t                addr  :36;
<a name="l00178"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#fe0a45244491b162cd62b1f8c8dbe553">00178</a>       uint64_t            reserved  : 4;
<a name="l00179"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#b9a21113c6079f8acc05bdc7a4ea7acf">00179</a>       uint64_t                size  :13;
<a name="l00180"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#b7d3dfe7515c59f5ae965372b3d0bcdf">00180</a>       uint64_t                   l  : 1;
<a name="l00181"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#63ce9dfd0daf2f2cf4b78247b9ef6806">00181</a>       uint64_t                   a  : 1;
<a name="l00182"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#af480d50acc07dbb24730e0a0f03d77c">00182</a>       uint64_t                   f  : 1;
<a name="l00183"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#4d8e407eb0edf6610804e8cea4dd260b">00183</a>       uint64_t                pool  : 3;
<a name="l00184"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#9a99787032e6bca4a51bf552c3f1c7b7">00184</a>       uint64_t                back  : 4;
<a name="l00185"></a><a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#169b2d9226c232aea46bd83b2caf6ca6">00185</a>       uint64_t                   i  : 1;
<a name="l00186"></a>00186 <span class="preprocessor">#else</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>      uint64_t                   i  : 1;
<a name="l00188"></a>00188       uint64_t                back  : 4;
<a name="l00189"></a>00189       uint64_t                pool  : 3;
<a name="l00190"></a>00190       uint64_t                   f  : 1;
<a name="l00191"></a>00191       uint64_t                   a  : 1;
<a name="l00192"></a>00192       uint64_t                   l  : 1;
<a name="l00193"></a>00193       uint64_t                size  :13;
<a name="l00194"></a>00194       uint64_t            reserved  : 4;
<a name="l00195"></a>00195       uint64_t                addr  :36;
<a name="l00196"></a>00196 <span class="preprocessor">#endif</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>   } s;
<a name="l00198"></a>00198 } <a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html">cvmx_oct_pci_dma_local_ptr_t</a>;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="comment"></span>
<a name="l00206"></a>00206 <span class="comment">/** Core: Information about PCI DMA operation.</span>
<a name="l00207"></a>00207 <span class="comment">  * This structure tells the core driver about the type of DMA </span>
<a name="l00208"></a>00208 <span class="comment">  * operation to be submitted to Octeon PCI DMA engines. The</span>
<a name="l00209"></a>00209 <span class="comment">  * Octeon PCI DMA command is built from the field defined here.</span>
<a name="l00210"></a>00210 <span class="comment">  * This structure is passed to the PCI send/receive api's. It is</span>
<a name="l00211"></a>00211 <span class="comment">  * not used in the instruction response API's.</span>
<a name="l00212"></a>00212 <span class="comment">  */</span>
<a name="l00213"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html">00213</a> <span class="keyword">typedef</span> <span class="keyword">union </span>{
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#cbdcee89472e872403076cecb991aaf9">00215</a>     uint64_t   u64;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="keyword">struct </span>{<span class="comment"></span>
<a name="l00218"></a>00218 <span class="comment">        /** Number of remote pointers in the operation. */</span>
<a name="l00219"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#0f2e9674ec43c78fd55daa34b208d185">00219</a>         uint64_t   nr:4;
<a name="l00220"></a>00220 <span class="comment"></span>
<a name="l00221"></a>00221 <span class="comment">        /** Number of local pointers in the operation. */</span>
<a name="l00222"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#29f645ab47595e1aa37b7dd5890aeede">00222</a>         uint64_t   nl:4;
<a name="l00223"></a>00223 <span class="comment"></span>
<a name="l00224"></a>00224 <span class="comment">        /** Determines DMA queue to use for this operation.</span>
<a name="l00225"></a>00225 <span class="comment">            There are 2 DMA queues forCN38XX, 5 for CN56XX and 8 for CN63XX. */</span>
<a name="l00226"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#21777e927e3b2d7ed2fd07d3a8dc3da4">00226</a>         uint64_t   q_no:3;
<a name="l00227"></a>00227 <span class="comment"></span>
<a name="l00228"></a>00228 <span class="comment">        /** CN56XX/63XX Only. Determines First PCI-Express Port for DMA. */</span>
<a name="l00229"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#8f9cee27de5c97fdf5afc0821e59d2aa">00229</a>         uint64_t   pciefport:1;
<a name="l00230"></a>00230 <span class="comment"></span>
<a name="l00231"></a>00231 <span class="comment">        /** CN56XX/63XX Only. Determines Last PCI-Express Port for DMA. */</span>
<a name="l00232"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#d80969d2132cdcf14151870bf6a330b5">00232</a>         uint64_t   pcielport:1;
<a name="l00233"></a>00233 <span class="comment"></span>
<a name="l00234"></a>00234 <span class="comment">        /** Reserved */</span>
<a name="l00235"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#15b164bfa0c71a534f729d30fcaa945a">00235</a>         uint64_t   rsvd:3;
<a name="l00236"></a>00236 <span class="comment"></span>
<a name="l00237"></a>00237 <span class="comment">        /** Flags describe the direction of DMA and post-DMA</span>
<a name="l00238"></a>00238 <span class="comment">            operations as defined in the enum oct_pci_dma_flags_t */</span>
<a name="l00239"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#73df0c62867ecc63d87d80cf1c20407d">00239</a>         <a class="code" href="cvm-pci-dma_8h.html#9c55479597ea58ab1b6d3b74c8edfd9e">oct_pci_dma_flags_t</a>   flags:8;
<a name="l00240"></a>00240 <span class="comment"></span>
<a name="l00241"></a>00241 <span class="comment">        /** Physical address of WQE buffer or location in Octeon memory</span>
<a name="l00242"></a>00242 <span class="comment">            for post-DMA operation. */</span>
<a name="l00243"></a><a class="code" href="unioncvm__pci__dma__cmd__t.html#2ebd20e3bb4d10838da1584446d30543">00243</a>         uint64_t   ptr:40;
<a name="l00244"></a>00244     } s;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 } <a class="code" href="unioncvm__pci__dma__cmd__t.html">cvm_pci_dma_cmd_t</a>;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="preprocessor">#define  INIT_PCI_DMA_CMD(pcmd)         (pcmd-&gt;u64 = 0)</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="comment">/* Get the direction bits from the flags field of the CVM PCI DMA Command. */</span>
<a name="l00253"></a>00253 <span class="preprocessor">#define  CVM_PCI_DMA_DIR(dmacmdptr)     (dmacmdptr-&gt;s.flags &amp; 0x3)</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span>
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="comment"></span>
<a name="l00257"></a>00257 <span class="comment">/** Core: Scatter response information </span>
<a name="l00258"></a>00258 <span class="comment">  * This structure is passed by application when calling a scatter response</span>
<a name="l00259"></a>00259 <span class="comment">  * API.</span>
<a name="l00260"></a>00260 <span class="comment">  */</span> 
<a name="l00261"></a><a class="code" href="structcvm__pci__scatter__resp__t.html">00261</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00262"></a>00262 <span class="comment"></span>
<a name="l00263"></a>00263 <span class="comment">    /** The response header for the instruction. Ignored for</span>
<a name="l00264"></a>00264 <span class="comment">        cvm_dma_send_scatter_response_direct()  since ORH is part of </span>
<a name="l00265"></a>00265 <span class="comment">        response data for direct API. */</span>
<a name="l00266"></a><a class="code" href="structcvm__pci__scatter__resp__t.html#29a91a7209e236d6cc818f55b650489c">00266</a>     <a class="code" href="unioncvmx__resp__hdr__t.html">cvmx_resp_hdr_t</a>      orh;
<a name="l00267"></a>00267 <span class="comment"></span>
<a name="l00268"></a>00268 <span class="comment">    /** The status to be returned to host. Ignored for </span>
<a name="l00269"></a>00269 <span class="comment">        cvm_dma_send_scatter_response_direct() since status is part of </span>
<a name="l00270"></a>00270 <span class="comment">        response data for direct API. */</span>
<a name="l00271"></a><a class="code" href="structcvm__pci__scatter__resp__t.html#5823a43f6e116d512ba796693c730567">00271</a>     uint64_t             status;
<a name="l00272"></a>00272 <span class="comment"></span>
<a name="l00273"></a>00273 <span class="comment">    /** Number of entries in the scatter list. */</span>
<a name="l00274"></a><a class="code" href="structcvm__pci__scatter__resp__t.html#e662b35b0e92b03c57054cab72a65922">00274</a>     uint32_t             remote_segs;
<a name="l00275"></a>00275 <span class="comment"></span>
<a name="l00276"></a>00276 <span class="comment">    /** PCIe port to use to read scatter list and send response. */</span>
<a name="l00277"></a><a class="code" href="structcvm__pci__scatter__resp__t.html#3d79d3933ed3f563b701360ed481b81b">00277</a>     uint8_t              pcie_port;
<a name="l00278"></a>00278 <span class="comment"></span>
<a name="l00279"></a>00279 <span class="comment">    /** Reserved. */</span> 
<a name="l00280"></a><a class="code" href="structcvm__pci__scatter__resp__t.html#9cad1b7998f9d7868d3fd1c7dbd36a9d">00280</a>     uint8_t             reserved[3];
<a name="l00281"></a>00281 <span class="comment"></span>
<a name="l00282"></a>00282 <span class="comment">    /** The scatter list that contains the host output buffer addresses. */</span>
<a name="l00283"></a><a class="code" href="structcvm__pci__scatter__resp__t.html#7fb6204c639dae1846a5967455c64514">00283</a>     <a class="code" href="structocteon__sg__entry__t.html">octeon_sg_entry_t</a>   *sg_entry;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 } <a class="code" href="structcvm__pci__scatter__resp__t.html">cvm_pci_scatter_resp_t</a>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 
<a name="l00288"></a>00288  
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="comment"></span>
<a name="l00292"></a>00292 <span class="comment">/** Core: Format for size of remote data buffer in a PCI DMA component.</span>
<a name="l00293"></a>00293 <span class="comment">  * Refer to section 10.5.3 in Octeon Hardware Manual. */</span>
<a name="l00294"></a><a class="code" href="unioncvm__dma__remote__len__t.html">00294</a> <span class="keyword">typedef</span> <span class="keyword">union </span>{
<a name="l00295"></a>00295 
<a name="l00296"></a><a class="code" href="unioncvm__dma__remote__len__t.html#24498d7a242081e20bdd4b209950006f">00296</a>    uint64_t  u64;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298    <span class="keyword">struct </span>{
<a name="l00299"></a><a class="code" href="unioncvm__dma__remote__len__t.html#5a438cd65a1e082c2072353a498173a9">00299</a>       uint16_t  len[4];
<a name="l00300"></a>00300    } l;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 } <a class="code" href="unioncvm__dma__remote__len__t.html">cvm_dma_remote_len_t</a>; 
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">/**  Core:  Address of the host machine are presented to PCI DMA routines in</span>
<a name="l00309"></a>00309 <span class="comment">  *  this format. The driver translates this to the PCI component format.</span>
<a name="l00310"></a>00310 <span class="comment">  */</span>
<a name="l00311"></a><a class="code" href="unioncvm__dma__remote__ptr__t.html">00311</a> <span class="keyword">typedef</span> <span class="keyword">union </span>{
<a name="l00312"></a>00312 
<a name="l00313"></a><a class="code" href="unioncvm__dma__remote__ptr__t.html#cd7ee1c01da0da5a963699367b2b121b">00313</a>    uint64_t  u64;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315    <span class="keyword">struct </span>{
<a name="l00316"></a><a class="code" href="unioncvm__dma__remote__ptr__t.html#693ef2640c8df0ae531d2c3ed8dea2fd">00316</a>       uint64_t     addr:48;
<a name="l00317"></a><a class="code" href="unioncvm__dma__remote__ptr__t.html#72e0761ec562a70638c25163083e11d7">00317</a>       uint64_t     size:16;
<a name="l00318"></a>00318    }s;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 }  <a class="code" href="unioncvm__dma__remote__ptr__t.html">cvm_dma_remote_ptr_t</a>;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="preprocessor">#ifdef CVM_PCI_TRACK_DMA</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span>
<a name="l00328"></a>00328 <span class="comment">/* Application should call this routine for all WQE's received from port 0x2f.</span>
<a name="l00329"></a>00329 <span class="comment">   The DMA tracker had modified the DMA command to generate these WQE. They</span>
<a name="l00330"></a>00330 <span class="comment">   should be sent to the DMA tracker routine for proper processing.</span>
<a name="l00331"></a>00331 <span class="comment">*/</span>
<a name="l00332"></a>00332 <span class="keywordtype">void</span>  <a class="code" href="cvm-pci-dma_8h.html#bdb7e5a397efb3d22d7a0e16b367ce88">cvm_pci_dma_remove_from_tracker_list</a>(cvmx_wqe_t  *wqe);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <span class="comment">/* Applications can call this routine to print the list of DMA commands that</span>
<a name="l00336"></a>00336 <span class="comment">   have not been processed by the DMA engine.</span>
<a name="l00337"></a>00337 <span class="comment">*/</span>
<a name="l00338"></a>00338 <span class="keywordtype">void</span> <a class="code" href="cvm-pci-dma_8h.html#fc26a651709e499dc0fe7e390dddad81">cvm_pci_dma_dump_tracker_list</a>(<span class="keywordtype">void</span>);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="preprocessor">#endif</span>
<a name="l00342"></a>00342 <span class="preprocessor"></span>
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 <span class="comment">/*------------------------- Inline Routines -------------------------------*/</span>
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 <span class="comment"></span>
<a name="l00351"></a>00351 <span class="comment">/** Core: Routine to fill the PCI DMA instruction local pointers. This </span>
<a name="l00352"></a>00352 <span class="comment">  * routines translates LINKED, DIRECT and GATHER mode pointers to a list of</span>
<a name="l00353"></a>00353 <span class="comment">  * local pointers as required by the PCI DMA engine. Applications that</span>
<a name="l00354"></a>00354 <span class="comment">  * require calling a direct PCI DMA API like cvm_pci_dma_raw() should call</span>
<a name="l00355"></a>00355 <span class="comment">  * this function to prepare the local pointer list.</span>
<a name="l00356"></a>00356 <span class="comment">  *</span>
<a name="l00357"></a>00357 <span class="comment">  * @param local_ptr: Local pointer list to be passed to DMA instruction</span>
<a name="l00358"></a>00358 <span class="comment">  * @param lptr     : Local pointer list (linked/gather) available with app.</span>
<a name="l00359"></a>00359 <span class="comment">  * @param segs     : Number of local pointers.</span>
<a name="l00360"></a>00360 <span class="comment">  * @param ptr_type : CVM_DIRECT_DATA, CVM_LINKED_DATA or CVM_GATHER_DATA.</span>
<a name="l00361"></a>00361 <span class="comment">  * @return Sum of buffer sizes for the addresses copied into local_ptr.</span>
<a name="l00362"></a>00362 <span class="comment">  */</span>
<a name="l00363"></a>00363 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00364"></a><a class="code" href="cvm-pci-dma_8h.html#eba5f7c4feaec154f1ba4594ac622e50">00364</a> <a class="code" href="cvm-pci-dma_8h.html#eba5f7c4feaec154f1ba4594ac622e50">cvm_dma_fill_local_ptrs</a>(<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html">cvmx_oct_pci_dma_local_ptr_t</a>    *local_ptr,
<a name="l00365"></a>00365                         cvmx_buf_ptr_t                   lptr,
<a name="l00366"></a>00366                         uint32_t                         segs,
<a name="l00367"></a>00367                         <a class="code" href="cvm-pci_8h.html#451d7a5c26a37002543c86c9b82dd203">cvm_ptr_type_t</a>                   ptr_type)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369     uint32_t         total_bytes=0, i;
<a name="l00370"></a>00370     cvmx_buf_ptr_t   *list;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="keywordflow">switch</span>(ptr_type) {
<a name="l00373"></a>00373         <span class="keywordflow">case</span> <a class="code" href="cvm-pci_8h.html#451d7a5c26a37002543c86c9b82dd203dbc9f9f8d6f0b8f000a38457bffc3ae0">CVM_DIRECT_DATA</a>:
<a name="l00374"></a>00374             <span class="keywordflow">if</span>(segs == 1) {
<a name="l00375"></a>00375                 <span class="keywordflow">if</span>(lptr.s.size &gt; MAX_PCI_DMA_LOCAL_BUF_SIZE)
<a name="l00376"></a>00376                     <span class="keywordflow">return</span> -1;
<a name="l00377"></a>00377                 local_ptr-&gt;<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#2d4cfbd8dc65bedda536662aabf97c59">u64</a> = (lptr.u64 &amp; CVM_PCI_DMA_LOCAL_PTR_MASK);
<a name="l00378"></a>00378                 total_bytes = lptr.s.size;
<a name="l00379"></a>00379             }
<a name="l00380"></a>00380             <span class="keywordflow">break</span>;
<a name="l00381"></a>00381         <span class="keywordflow">case</span> <a class="code" href="cvm-pci_8h.html#451d7a5c26a37002543c86c9b82dd203a8c65cc198ef3870458ef9a1d753c73b">CVM_LINKED_DATA</a>:
<a name="l00382"></a>00382             <span class="keywordflow">if</span>(lptr.s.size &gt; MAX_PCI_DMA_LOCAL_BUF_SIZE)
<a name="l00383"></a>00383                 <span class="keywordflow">return</span> -1;
<a name="l00384"></a>00384             local_ptr-&gt;<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#2d4cfbd8dc65bedda536662aabf97c59">u64</a> = (lptr.u64 &amp; CVM_PCI_DMA_LOCAL_PTR_MASK);
<a name="l00385"></a>00385             total_bytes    = local_ptr-&gt;<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#457c896e400d4e9278be2a0615647c35">s</a>.<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#b9a21113c6079f8acc05bdc7a4ea7acf">size</a>;
<a name="l00386"></a>00386             local_ptr++;
<a name="l00387"></a>00387             list = (cvmx_buf_ptr_t *)CVM_DRV_GET_PTR(lptr.s.addr - 8);
<a name="l00388"></a>00388             <span class="keywordflow">for</span>(i = 1; i &lt; segs; i++, local_ptr++) {
<a name="l00389"></a>00389                 <span class="keywordflow">if</span>(list-&gt;s.size &gt; MAX_PCI_DMA_LOCAL_BUF_SIZE)
<a name="l00390"></a>00390                     <span class="keywordflow">return</span> -1;
<a name="l00391"></a>00391                 local_ptr-&gt;<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#2d4cfbd8dc65bedda536662aabf97c59">u64</a>  = (list-&gt;u64 &amp; CVM_PCI_DMA_LOCAL_PTR_MASK);
<a name="l00392"></a>00392                 total_bytes    += local_ptr-&gt;<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#457c896e400d4e9278be2a0615647c35">s</a>.<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#b9a21113c6079f8acc05bdc7a4ea7acf">size</a>;
<a name="l00393"></a>00393                 list = (cvmx_buf_ptr_t *)CVM_DRV_GET_PTR(list-&gt;s.addr - 8);
<a name="l00394"></a>00394             }
<a name="l00395"></a>00395             <span class="keywordflow">break</span>;
<a name="l00396"></a>00396         <span class="keywordflow">case</span> <a class="code" href="cvm-pci_8h.html#451d7a5c26a37002543c86c9b82dd203006dd98b74edc3eee28a9010eebb4aee">CVM_GATHER_DATA</a>:
<a name="l00397"></a>00397             list = (cvmx_buf_ptr_t *)CVM_DRV_GET_PTR(lptr.s.addr);
<a name="l00398"></a>00398             DBG_PRINT(DBG_FLOW, <span class="stringliteral">"cvm_pci_dma: gptr @ 0x%p\n"</span>, list);
<a name="l00399"></a>00399             DBG_PRINT(DBG_FLOW, <span class="stringliteral">"gather list contents\n"</span>);
<a name="l00400"></a>00400             <span class="keywordflow">for</span>(i = 0; i &lt; segs; i++, local_ptr++) {
<a name="l00401"></a>00401                 <span class="keywordflow">if</span>(list[i].s.size &gt; MAX_PCI_DMA_LOCAL_BUF_SIZE)
<a name="l00402"></a>00402                     <span class="keywordflow">return</span> -1;
<a name="l00403"></a>00403                 local_ptr-&gt;<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#2d4cfbd8dc65bedda536662aabf97c59">u64</a>  = (list[i].u64 &amp; CVM_PCI_DMA_LOCAL_PTR_MASK);
<a name="l00404"></a>00404                 total_bytes    += local_ptr-&gt;<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#457c896e400d4e9278be2a0615647c35">s</a>.<a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html#b9a21113c6079f8acc05bdc7a4ea7acf">size</a>;
<a name="l00405"></a>00405                 DBG_PRINT(DBG_FLOW, <span class="stringliteral">"gather list[%d]: 0x%llx\n"</span>, i, cast64(list[i].u64));
<a name="l00406"></a>00406             }
<a name="l00407"></a>00407             <span class="keywordflow">break</span>;
<a name="l00408"></a>00408         <span class="keywordflow">case</span> <a class="code" href="cvm-pci_8h.html#451d7a5c26a37002543c86c9b82dd20389b290e8f62c2a58406a67a764d87dea">CVM_NULL_DATA</a>:  <span class="comment">/* Nothing to do here/. */</span>
<a name="l00409"></a>00409             <span class="keywordflow">break</span>;
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411     CVMX_SYNCWS;
<a name="l00412"></a>00412     <span class="keywordflow">return</span> total_bytes;
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415 
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 <span class="comment">/*-------------------------- FUNCTION PROTOTYPES ---------------------------*/</span>
<a name="l00422"></a>00422 <span class="comment"></span>
<a name="l00423"></a>00423 <span class="comment">/** Core: Initialize a PCI DMA instruction chunk. This routine allocates the</span>
<a name="l00424"></a>00424 <span class="comment"> *  first chunk for each DMA instruction queue and writes the chunk addr,</span>
<a name="l00425"></a>00425 <span class="comment"> *  maximum writeable space in chunk to CSR. It also allocates extra chunk for</span>
<a name="l00426"></a>00426 <span class="comment"> *  fast chaining.</span>
<a name="l00427"></a>00427 <span class="comment"> *  @return Success: 0; Failure: 1.</span>
<a name="l00428"></a>00428 <span class="comment"> */</span>
<a name="l00429"></a>00429 <span class="keywordtype">int</span>  <a class="code" href="cvm-pci-dma_8h.html#5ff9888036a38704dea0eabe5bca7119">cvm_dma_queue_init</a>(<a class="code" href="structcvm__oct__dev__t.html">cvm_oct_dev_t</a>  *oct);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 
<a name="l00436"></a>00436 <span class="comment"></span>
<a name="l00437"></a>00437 <span class="comment">/**  Core: This routines creates a PCI DMA instruction based on information in</span>
<a name="l00438"></a>00438 <span class="comment"> *   the DMA header and local and remote pointers and buffer sizes passed to it.</span>
<a name="l00439"></a>00439 <span class="comment"> *   Applications have more control over the DMA operation when using this API.</span>
<a name="l00440"></a>00440 <span class="comment"> *   This function can be called for INBOUND &amp; OUTBOUND operations only for all</span>
<a name="l00441"></a>00441 <span class="comment"> *   variants of Octeon.</span>
<a name="l00442"></a>00442 <span class="comment"> *</span>
<a name="l00443"></a>00443 <span class="comment"> *   @param  dma_hdr  -  the DMA instruction header.</span>
<a name="l00444"></a>00444 <span class="comment"> *   @param  lptr     -  list of local  data pointers.</span>
<a name="l00445"></a>00445 <span class="comment"> *   @param  rptr     -  list of remote (host/peer) addresses.</span>
<a name="l00446"></a>00446 <span class="comment"> *   @return Success: 0; Failure: -ENOMEM, -EINVAL.</span>
<a name="l00447"></a>00447 <span class="comment"> */</span>
<a name="l00448"></a>00448 <span class="keywordtype">int</span>
<a name="l00449"></a>00449 <a class="code" href="cvm-pci-dma_8h.html#5c0b66f728ba7b188b56ffcf17ac96b8">cvm_pci_dma_raw</a>(<a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html">cvmx_oct_pci_dma_inst_hdr_t</a>      *dma_hdr,
<a name="l00450"></a>00450                 <a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html">cvmx_oct_pci_dma_local_ptr_t</a>     *lptr,
<a name="l00451"></a>00451                 <a class="code" href="unioncvm__dma__remote__ptr__t.html">cvm_dma_remote_ptr_t</a>             *rptr);
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 <span class="comment"></span>
<a name="l00455"></a>00455 <span class="comment">/**  Core: This routines creates a PCI DMA instruction based on information in</span>
<a name="l00456"></a>00456 <span class="comment"> *   the DMA header and local and remote pointers and buffer sizes passed to it.</span>
<a name="l00457"></a>00457 <span class="comment"> *   Applications have more control over the DMA operation when using this API.</span>
<a name="l00458"></a>00458 <span class="comment"> *   This function can be called for INBOUND &amp; OUTBOUND operations.</span>
<a name="l00459"></a>00459 <span class="comment"> *   For CN56XX &amp; CN63xx, an application can also achieve INTERNAL-ONLY or</span>
<a name="l00460"></a>00460 <span class="comment"> *   EXTERNAL-ONLY operations using this API.</span>
<a name="l00461"></a>00461 <span class="comment"> *   Based on the DMA type specified, the firstptrs and lastptrs will be</span>
<a name="l00462"></a>00462 <span class="comment"> *   interpreted differently. In all cases, the pointers from the firstptrs</span>
<a name="l00463"></a>00463 <span class="comment"> *   list will be copied into the DMA instruction chunk, followed by the </span>
<a name="l00464"></a>00464 <span class="comment"> *   pointers in the lastptrs list.</span>
<a name="l00465"></a>00465 <span class="comment"> *</span>
<a name="l00466"></a>00466 <span class="comment"> *   @param  q_no      -  The PCI DMA queue to use for this DMA operation.</span>
<a name="l00467"></a>00467 <span class="comment"> *                        The DMA instruction header does not have a field for</span>
<a name="l00468"></a>00468 <span class="comment"> *                        the queue to be used. So this is passed separately for</span>
<a name="l00469"></a>00469 <span class="comment"> *                        CN56XX &amp; CN63XX.</span>
<a name="l00470"></a>00470 <span class="comment"> *   @param  dma_hdr   -  the DMA instruction header.</span>
<a name="l00471"></a>00471 <span class="comment"> *   @param  firstptrs -  first set of pointers.</span>
<a name="l00472"></a>00472 <span class="comment"> *   @param  lastptrs  -  second set of pointers.</span>
<a name="l00473"></a>00473 <span class="comment"> *   @return Success: 0; Failure: -ENOMEM, -EINVAL.</span>
<a name="l00474"></a>00474 <span class="comment"> */</span>
<a name="l00475"></a>00475 <span class="keywordtype">int</span>
<a name="l00476"></a>00476 <a class="code" href="cvm-pci-dma_8h.html#15a10874918a536205a8fa633b4037ec">cvm_pcie_dma_raw</a>(<span class="keywordtype">int</span>                              q_no,
<a name="l00477"></a>00477                  <a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html">cvmx_oct_pci_dma_inst_hdr_t</a>     *dma_hdr,
<a name="l00478"></a>00478                  <span class="keywordtype">void</span>                            *firstptrs,
<a name="l00479"></a>00479                  <span class="keywordtype">void</span>                            *lastptrs);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="comment"></span>
<a name="l00483"></a>00483 <span class="comment">/** Core: Write data to host or PCI-Express memory using Octeon PCI DMA engine.</span>
<a name="l00484"></a>00484 <span class="comment">  * @param cmd  - describes the DMA operation. See cvm_pci_dma_cmd_t for</span>
<a name="l00485"></a>00485 <span class="comment">  *               description of fields. </span>
<a name="l00486"></a>00486 <span class="comment">  * @param lptr - list of addresses in Octeon local memory (max 15).</span>
<a name="l00487"></a>00487 <span class="comment">  * @param rptr - list of addresses in host/PCI-E memory (max 15).</span>
<a name="l00488"></a>00488 <span class="comment">  * @return Success: 0; Failure: -ENOMEM, -EINVAL. </span>
<a name="l00489"></a>00489 <span class="comment">  */</span>
<a name="l00490"></a>00490 <span class="keywordtype">int</span>
<a name="l00491"></a>00491 <a class="code" href="cvm-pci-dma_8h.html#aedebf9d4cf969e2f017e822461a44e0">cvm_pci_dma_send_data</a>(<a class="code" href="unioncvm__pci__dma__cmd__t.html">cvm_pci_dma_cmd_t</a>     *cmd,
<a name="l00492"></a>00492                       cvmx_buf_ptr_t        *lptr, 
<a name="l00493"></a>00493                       <a class="code" href="unioncvm__dma__remote__ptr__t.html">cvm_dma_remote_ptr_t</a>  *rptr);
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 
<a name="l00496"></a>00496 <span class="comment"></span>
<a name="l00497"></a>00497 <span class="comment">/** Core: Read data from host or PCI-Express memory using Octeon PCI DMA engine.</span>
<a name="l00498"></a>00498 <span class="comment">  * @param cmd  - describes the DMA operation. See cvm_pci_dma_cmd_t for</span>
<a name="l00499"></a>00499 <span class="comment">  *               description of fields. </span>
<a name="l00500"></a>00500 <span class="comment">  * @param lptr - list of addresses in Octeon local memory (max 15).</span>
<a name="l00501"></a>00501 <span class="comment">  * @param rptr - list of addresses in host/PCI-E memory (max 15).</span>
<a name="l00502"></a>00502 <span class="comment">  * @return Success: 0; Failure: -ENOMEM, -EINVAL. </span>
<a name="l00503"></a>00503 <span class="comment">  */</span>
<a name="l00504"></a>00504 <span class="keywordtype">int</span>
<a name="l00505"></a>00505 <a class="code" href="cvm-pci-dma_8h.html#4ebbf8a86fefe0238ae2a57c830cf09d">cvm_pci_dma_recv_data</a>(<a class="code" href="unioncvm__pci__dma__cmd__t.html">cvm_pci_dma_cmd_t</a>     *cmd,
<a name="l00506"></a>00506                       cvmx_buf_ptr_t        *lptr, 
<a name="l00507"></a>00507                       <a class="code" href="unioncvm__dma__remote__ptr__t.html">cvm_dma_remote_ptr_t</a>  *rptr);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 
<a name="l00510"></a>00510 <span class="comment"></span>
<a name="l00511"></a>00511 <span class="comment">/** Core: Function to get a completion pointer from core driver pool.</span>
<a name="l00512"></a>00512 <span class="comment"> *        The application would use the comp_byte in the structure as a </span>
<a name="l00513"></a>00513 <span class="comment"> *        completion word for PCI DMA.</span>
<a name="l00514"></a>00514 <span class="comment"> * @return Success: Pointer to completion byte; Failure: NULL.</span>
<a name="l00515"></a>00515 <span class="comment"> */</span>
<a name="l00516"></a>00516 <a class="code" href="structcvm__dma__comp__ptr__t.html">cvm_dma_comp_ptr_t</a> *    <a class="code" href="cvm-pci-dma_8h.html#af1a8951b180e97d8157d6c1d2032359">cvm_get_dma_comp_ptr</a>(<span class="keywordtype">void</span>);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 <span class="comment"></span>
<a name="l00519"></a>00519 <span class="comment">/** Core: Function to free completion pointer to core driver pool.</span>
<a name="l00520"></a>00520 <span class="comment"> */</span>
<a name="l00521"></a>00521 <span class="keywordtype">void</span>    <a class="code" href="cvm-pci-dma_8h.html#8c8ff553e3374fda08d688617be3dfb2">cvm_release_dma_comp_ptr</a>(<a class="code" href="structcvm__dma__comp__ptr__t.html">cvm_dma_comp_ptr_t</a> *ptr);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 
<a name="l00525"></a>00525 <span class="comment"></span>
<a name="l00526"></a>00526 <span class="comment">/** Core: Wrapper around the cvm_pci_dma_raw() function.</span>
<a name="l00527"></a>00527 <span class="comment"> *        cvm_pci_dma_send_direct() existed in older releases and may be</span>
<a name="l00528"></a>00528 <span class="comment"> *        removed in the future.</span>
<a name="l00529"></a>00529 <span class="comment"> */</span>
<a name="l00530"></a>00530 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00531"></a><a class="code" href="cvm-pci-dma_8h.html#06a3a35352277e1f4735eea19d79c1a1">00531</a> <a class="code" href="cvm-pci-dma_8h.html#06a3a35352277e1f4735eea19d79c1a1">cvm_pci_dma_send_direct</a>(<a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html">cvmx_oct_pci_dma_inst_hdr_t</a>      *dma_hdr,
<a name="l00532"></a>00532                         <a class="code" href="unioncvmx__oct__pci__dma__local__ptr__t.html">cvmx_oct_pci_dma_local_ptr_t</a>     *lptr,
<a name="l00533"></a>00533                         <a class="code" href="unioncvm__dma__remote__ptr__t.html">cvm_dma_remote_ptr_t</a>             *rptr)
<a name="l00534"></a>00534 {
<a name="l00535"></a>00535     <span class="keywordflow">return</span> <a class="code" href="cvm-pci-dma_8h.html#5c0b66f728ba7b188b56ffcf17ac96b8">cvm_pci_dma_raw</a>(dma_hdr, lptr, rptr);
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 
<a name="l00540"></a>00540 <span class="keywordtype">void</span>    <a class="code" href="cvm-pci-dma_8h.html#3d36a54b739a25ba6ab69505dd501b47">cn56xx_setup_dma_intr_threshold</a>(<span class="keywordtype">int</span> q_no);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <span class="comment">/* Parse and print the contents of the 64-bit PCI DMA header. */</span>
<a name="l00543"></a>00543 <span class="keywordtype">void</span> <a class="code" href="cvm-pci-dma_8h.html#44270257fe34f9e7490e249a3c2cb8cc">cvm_pci_dma_print_header</a>(<a class="code" href="unioncvmx__oct__pci__dma__inst__hdr__t.html">cvmx_oct_pci_dma_inst_hdr_t</a>  *dmahdr);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 <span class="keywordtype">void</span>
<a name="l00547"></a>00547 <a class="code" href="cvm-pci-dma_8h.html#d4012d9761bbf54415803f7de1db32e0">cvm_drv_debug_print_dmaq</a>(<span class="keywordtype">int</span> q_no);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 <span class="preprocessor">#endif  </span><span class="comment">/*  __CVM_PCI_DMA_H__ */</span>
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="comment">/* $Id: cvm-pci-dma.h 63294 2011-08-09 21:48:01Z panicker $ */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Nov 22 15:40:59 2011 for Octeon PCI Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
