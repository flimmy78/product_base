<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Octeon PCI Driver: OCTEON Driver Output Operation.</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<h1><a class="anchor" name="oq-main">OCTEON Driver Output Operation.</a></h1>This section will discuss in detail the steps involved in receiving packets from OCTEON via the PCI output rings.<p>
<br>
<br>
 <h2><a class="anchor" name="oq-sec1">
OCTEON Output ring initialization.</a></h2>
The OCTEON PCI host driver (provided as a linux kernel module in the OCTEON-PCI-BASE package) is responsible for the initialization of all OCTEON devices in the system.<p>
During initialization, the driver would allocate memory for the descriptor ring to be used by the OCTEON PCI output queues. For each descriptor ring, the driver allocates a contiguous memory in host memory that can accomodate a fixed number of descriptors. The starting address of each descriptor ring and the number of descriptors it accomodates are programmed into OCTEON by the driver. Each output queue descriptor is 16-bytes in size and hold a 8-byte pointer to a host data buffer and a 8-byte pointer to a info buffer.<p>
<br>
<br>
 <h2><a class="anchor" name="oq-sec2">
OCTEON PCI driver application interfaces</a></h2>
The OCTEON PCI output rings can be used to receive unsolicited output from the core application. The data arrives with a response header which helps the driver identify the type of packet. Any kernel-mode application interested can register a dispatch function with the host PCI driver with the opcode associated with the type.<p>
To register a function call OCTEON_register_dispatch_fn() with a function pointer and the opcode for which the function is to be registered. An additional argument can be passed during registration which will be passed as as a parameter by the driver when the dispatch function is called.<p>
To unregister a dispatch function, call OCTEON_unregister_dispatch_fn() with the opcode for which the function is to be unregistered. Once this call returns, any packets with the given opcode will be dropped.<p>
The OCTEON_register_droq_ops() API can be called by application with a OCTEON_droq_ops_t structure (defined in <a class="el" href="cavium__defs_8h.html">cavium_defs.h</a>). The structure contains a function pointer which will be called by the driver for all packets arriving on all output rings irrespective of their opcode. Note that once OCTEON_register_droq_ops() is called, the normal dispatch mechanism is stopped for that output ring. You can call OCTEON_unregister_droq_ops() to unregister the function pointer and the normal dispatch mechanism continues. The OCTEON NIC driver module uses this API to handle network traffic on output queues. It is not recommended to call this API if the OCTEON NIC driver module is used.<p>
<br>
<br>
 <h2><a class="anchor" name="oq-sec3">
Driver interaction with OCTEON for Output ring processing</a></h2>
OCTEON output queue hardware can write data into the descriptor rings in two ways:<p>
1. It can write the entire data along with information about the packet length directly into the descriptor ring's data buffers. The info buffers are not used in this case.<p>
2. It can write the length information and any additionally programmed bytes of the packet into the info buffer and write the remaining bytes of the packet into the data buffers of a descriptor ring.<p>
The OCTEON PCI driver programs OCTEON to use the latter method. For each packet that arrives in the descriptor ring buffers, the length of the packet and first 8 bytes of the packet are written into the info buffer. The rest of the packet appears in the data buffer.<p>
The core component of the OCTEON PCI driver is used by all applications to send the packets to the PCI output queues. It adds a 8-byte header describing the packet - in particular, the opcode associated with the packet. These 8 bytes appear in the info buffer of the host descriptor ring and is consumed locally by the host PCI driver. The data buffer is forwarded to any kernel -space application that had registered a function to accept packets with the opcode seen in the packet.<p>
<b>NOTE:</b> See driver/common/OCTEON-opcodes.h for opcodes reserved for use by driver and applications released by Cavium.<p>
When a packet arrives, the driver checks for a dispatch function associated with the opcode in the response header and if a function exists, it calls it with data buffer enclosed in a recv_info structure (OCTEON_recv_info_t defined in <a class="el" href="cavium__defs_8h.html">cavium_defs.h</a>). The format of response header sent by the core application is defined in OCTEON_resp_hdr_t in <a class="el" href="cavium__defs_8h.html">cavium_defs.h</a>. It is the responsibility of the application to free the buffer sent to it by the driver. The driver provides a function - free_recv_buffer() - for freeing the received data buffers.<p>
The host PCI driver takes care of refilling the used data buffers in a descriptor ring and sending credits to OCTEON with the new buffers.<p>
<br>
<br>
 <h2><a class="anchor" name="oq-sec4">
kernel-space application example.</a></h2>
The PCI driver package provides an example application that demonstrate how to register a function to receive packets arriving on the output rings, how to process information in the dispatched packet and how to free the data buffers. The example sources can be found at OCTEON-SDK/components/driver/host/test/kernel/droq-test. See the documention on the <a href="test-main.html">test applications in the PCI driver package </a> for more details. <hr size="1"><address style="align: right;"><small>Generated on Tue Nov 22 15:41:00 2011 for Octeon PCI Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
