<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Octeon PCI Driver: droq-ops Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>droq-ops</h1><a href="droq-ops.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*! \file droq-ops </span>
<a name="l00002"></a>00002 <span class="comment">    \brief This file is not part of the driver sources.  The contents of this file are used in HTML document generation.</span>
<a name="l00003"></a>00003 <span class="comment">*/</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">/*! \page oq-main OCTEON Driver Output Operation.</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">This section will discuss in detail the steps involved in receiving packets from OCTEON via the PCI output rings.</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">&lt;br&gt;&lt;br&gt;</span>
<a name="l00011"></a>00011 <span class="comment">\section oq-sec1  OCTEON Output ring initialization.</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">The OCTEON PCI host driver (provided as a linux kernel module in the OCTEON-PCI-BASE package) is responsible for the initialization of all OCTEON devices in the system.</span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment">During initialization, the driver would allocate memory for the descriptor ring to be used by the OCTEON PCI output queues. For each descriptor ring, the driver allocates a contiguous memory in host memory that can accomodate a fixed number of descriptors. The starting address of each descriptor ring and the number of descriptors it accomodates are programmed into OCTEON by the driver. Each output queue descriptor is 16-bytes in size and hold a 8-byte pointer to a host data buffer and a 8-byte pointer to a info buffer. </span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">&lt;br&gt;&lt;br&gt;</span>
<a name="l00019"></a>00019 <span class="comment">\section oq-sec2 OCTEON PCI driver application interfaces</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment"> The OCTEON PCI output rings can be used to receive unsolicited output </span>
<a name="l00022"></a>00022 <span class="comment"> from the core application. The data arrives with a response header which</span>
<a name="l00023"></a>00023 <span class="comment"> helps the driver identify the type of packet. Any kernel-mode application</span>
<a name="l00024"></a>00024 <span class="comment"> interested can register a dispatch function with the host PCI driver with</span>
<a name="l00025"></a>00025 <span class="comment"> the opcode associated with the type.</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 <span class="comment"> To register a function call OCTEON_register_dispatch_fn() with a function</span>
<a name="l00028"></a>00028 <span class="comment"> pointer and the opcode for which the function is to be registered. An </span>
<a name="l00029"></a>00029 <span class="comment"> additional argument can be passed during registration which will be passed as</span>
<a name="l00030"></a>00030 <span class="comment"> as a parameter by the driver when the dispatch function is called.</span>
<a name="l00031"></a>00031 <span class="comment"> </span>
<a name="l00032"></a>00032 <span class="comment"> To unregister a dispatch function, call OCTEON_unregister_dispatch_fn() </span>
<a name="l00033"></a>00033 <span class="comment"> with the opcode for which the function is to be unregistered. Once this</span>
<a name="l00034"></a>00034 <span class="comment"> call returns, any packets with the given opcode will be dropped.</span>
<a name="l00035"></a>00035 <span class="comment"></span>
<a name="l00036"></a>00036 <span class="comment"> The OCTEON_register_droq_ops() API can be called by application with</span>
<a name="l00037"></a>00037 <span class="comment"> a OCTEON_droq_ops_t structure (defined in cavium_defs.h). The structure</span>
<a name="l00038"></a>00038 <span class="comment"> contains a function pointer which will be called by the driver for all</span>
<a name="l00039"></a>00039 <span class="comment"> packets arriving on all output rings irrespective of their opcode. Note </span>
<a name="l00040"></a>00040 <span class="comment"> that once OCTEON_register_droq_ops() is called, the normal dispatch </span>
<a name="l00041"></a>00041 <span class="comment"> mechanism is stopped for that output ring. You can call</span>
<a name="l00042"></a>00042 <span class="comment"> OCTEON_unregister_droq_ops() to unregister the function pointer and the</span>
<a name="l00043"></a>00043 <span class="comment"> normal dispatch mechanism continues. The OCTEON NIC driver module uses this</span>
<a name="l00044"></a>00044 <span class="comment"> API to handle network traffic on output queues. It is not recommended to call</span>
<a name="l00045"></a>00045 <span class="comment"> this API if the OCTEON NIC driver module is used.</span>
<a name="l00046"></a>00046 <span class="comment"></span>
<a name="l00047"></a>00047 <span class="comment"></span>
<a name="l00048"></a>00048 <span class="comment">&lt;br&gt;&lt;br&gt;</span>
<a name="l00049"></a>00049 <span class="comment"> \section oq-sec3  Driver interaction with OCTEON for Output ring processing</span>
<a name="l00050"></a>00050 <span class="comment"></span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">OCTEON output queue hardware can write data into the descriptor rings in two ways:</span>
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="comment">1. It can write the entire data along with information about the packet length directly into the descriptor ring's data buffers. The info buffers are not used in this case.</span>
<a name="l00055"></a>00055 <span class="comment"></span>
<a name="l00056"></a>00056 <span class="comment">2. It can write the length information and any additionally programmed bytes of the packet into the info buffer and write the remaining bytes of the packet into the data buffers of a descriptor ring.</span>
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment">The OCTEON PCI driver programs OCTEON to use the latter method. For each packet that arrives in the descriptor ring buffers, the length of the packet and first 8 bytes of the packet are written into the info buffer. The rest of the packet appears in the data buffer.</span>
<a name="l00059"></a>00059 <span class="comment"></span>
<a name="l00060"></a>00060 <span class="comment">The core component of the OCTEON PCI driver is used by all applications to send the packets to the PCI output queues. It adds a 8-byte header describing the packet - in particular, the opcode associated with the packet. These 8 bytes appear in the info buffer of the host descriptor ring and is consumed locally by the host PCI driver. The data buffer is forwarded to any kernel -space application that had registered a function to accept packets with the opcode seen in the packet.</span>
<a name="l00061"></a>00061 <span class="comment"></span>
<a name="l00062"></a>00062 <span class="comment">&lt;b&gt;NOTE:&lt;/b&gt; See driver/common/OCTEON-opcodes.h for opcodes reserved for use by</span>
<a name="l00063"></a>00063 <span class="comment">       driver and applications released by Cavium.</span>
<a name="l00064"></a>00064 <span class="comment"></span>
<a name="l00065"></a>00065 <span class="comment">When a packet arrives, the driver checks for a dispatch function associated with the opcode in the response header and if a function exists, it calls it with data buffer enclosed in a recv_info structure (OCTEON_recv_info_t defined in cavium_defs.h). The format of response header sent by the core application is defined in OCTEON_resp_hdr_t in cavium_defs.h. It is the responsibility of the application to free the buffer sent to it by the driver. The driver provides a function - free_recv_buffer() - for freeing the received data buffers.</span>
<a name="l00066"></a>00066 <span class="comment"></span>
<a name="l00067"></a>00067 <span class="comment">The host PCI driver takes care of refilling the used data buffers in a descriptor ring and sending credits to OCTEON with the new buffers.</span>
<a name="l00068"></a>00068 <span class="comment"></span>
<a name="l00069"></a>00069 <span class="comment">&lt;br&gt;&lt;br&gt;</span>
<a name="l00070"></a>00070 <span class="comment">\section oq-sec4  kernel-space application example.</span>
<a name="l00071"></a>00071 <span class="comment"></span>
<a name="l00072"></a>00072 <span class="comment">The PCI driver package provides an example application that demonstrate how to register a function to receive packets arriving on the output rings, how to process information in the dispatched packet and how to free the data buffers. The example sources can be found at OCTEON-SDK/components/driver/host/test/kernel/droq-test. See the documention on the &lt;a HREF=test-main.html &gt; test applications in the PCI driver package &lt;/a&gt; for more details.</span>
<a name="l00073"></a>00073 <span class="comment"></span>
<a name="l00074"></a>00074 <span class="comment"></span>
<a name="l00075"></a>00075 <span class="comment">*/</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Nov 22 15:40:59 2011 for Octeon PCI Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
